<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Pet App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                }
            }
        }
    </script>
<<<<<<< HEAD
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/animations.css">
=======
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(2deg); }
            50% { transform: translateY(-8px) rotate(0deg); }
            75% { transform: translateY(-5px) rotate(-2deg); }
        }
        @keyframes sick {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(3px) rotate(-2deg); }
            75% { transform: translateY(-2px) rotate(2deg); }
        }
        .pet-bounce {
            animation: bounce 1s ease infinite;
        }
        .pet-shake {
            animation: shake 0.5s ease infinite;
        }
        .pet-pulse {
            animation: pulse 1s ease infinite;
        }
        .pet-float {
            animation: float 3s ease-in-out infinite;
        }
        .pet-sick {
            animation: sick 2s ease-in-out infinite;
        }
        .dark .status-bar {
            background-color: #2d2d2d;
        }
        .status-bar {
            background-color: #e0e0e0;
        }
        .background-pattern {
            background-image: radial-gradient(#5D5CDE22 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.visible {
            opacity: 1;
        }
        .memory-card {
            perspective: 1000px;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }
        .memory-card.flipped .front {
            transform: rotateY(0deg);
        }
        .memory-card.flipped .back {
            transform: rotateY(180deg);
        }
        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition: transform 0.5s;
        }
        .front {
            transform: rotateY(-180deg);
        }
        .back {
            transform: rotateY(0deg);
        }
        /* Food animations */
        @keyframes food-appear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .food-appear {
            animation: food-appear 0.5s ease forwards;
        }
        /* Medicine animations */
        @keyframes medicine-effect {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.5); opacity: 0.4; }
            100% { transform: scale(2); opacity: 0; }
        }
        .medicine-effect {
            animation: medicine-effect 1s ease forwards;
        }
        /* Tab transitions */
        .tab-content {
            transition: opacity 0.3s;
        }
        
        /* Make entire button clickable */
        .action-btn {
            position: relative;
        }
        
        .action-btn span, 
        .action-btn svg {
            pointer-events: none;
        }
    </style>
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
</head>

<body class="bg-white dark:bg-gray-900 dark:text-white min-h-screen">
    <div id="app" class="max-w-md mx-auto p-4 min-h-screen flex flex-col">
        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <span id="toastMessage"></span>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="flex flex-col items-center justify-center space-y-6 h-full">
            <h1 class="text-3xl font-bold text-center text-primary">Virtual Pet</h1>
            <div class="w-64 h-64 relative">
                <div
                    class="bg-primary/10 dark:bg-primary/20 w-full h-full rounded-full flex items-center justify-center">
                    <img id="welcomePet" src="./assets/imgs/White_Cat_Logo.png" alt="Thú cưng ảo"
                        class="w-48 h-48 pet-bounce hinh-tron">
                </div>
            </div>
            <p class="text-center text-gray-600 dark:text-gray-300">Hãy chọn và chăm sóc thú cưng ảo của bạn</p>
            <div class="flex space-x-4">
                <button id="startButton"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg">
                    Bắt Đầu
                </button>
                <button id="continueButton"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg">
                    Tiếp Tục
                </button>
            </div>
        </div>

        <!-- Pet Selection Screen -->
        <div id="petSelectionScreen" class="hidden flex-col items-center space-y-6">
            <h2 class="text-2xl font-bold text-primary">Chọn Thú Cưng</h2>
            <div class="grid grid-cols-3 gap-4 max-h-80 overflow-y-auto">
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-orange-100 dark:bg-orange-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet1" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Mèo Mimi</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-blue-100 dark:bg-blue-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet2" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Thỏ Bon Bon</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-green-100 dark:bg-green-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet3" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Khủng Long Rex</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-purple-100 dark:bg-purple-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet4" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Gấu Trúc Panda</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-yellow-100 dark:bg-yellow-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet5" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Chó Lu</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div class="bg-red-100 dark:bg-red-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet6" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Chim Sẻ Ami</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-blue-100 dark:bg-blue-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet7" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Cá Vàng Fizz</p>
                </div>
                <div
                    class="pet-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-primary">
                    <div
                        class="bg-pink-100 dark:bg-pink-900/30 w-24 h-24 rounded-full flex items-center justify-center">
                        <div id="pet8" class="pet-preview w-20 h-20"></div>
                    </div>
                    <p class="mt-2 font-semibold">Chuột Zeri</p>
                </div>
            </div>
            <div class="pet-name mt-4 w-full max-w-xs">
                <label for="petName" class="block text-gray-700 dark:text-gray-300 mb-1">Tên thú cưng:</label>
                <input type="text" id="petName"
                    class="text-base w-full px-4 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800"
                    placeholder="Nhập tên cho thú cưng của bạn">
            </div>
            <button id="adoptButton"
                class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg">
                Nuôi Thú Cưng
            </button>
        </div>

        <!-- Main Game Screen -->
        <div id="gameScreen" class="hidden flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <span id="petGameName" class="font-bold text-xl text-primary"></span>
                    <span id="petLevel"
                        class="ml-2 bg-primary/20 text-primary dark:bg-primary/30 px-2 rounded-full text-sm">Lv.1</span>
                </div>
                <div class="flex space-x-2">
                    <button id="settingsButton" class="text-gray-600 dark:text-gray-300 hover:text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Status Bars -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Đói</span>
                        <span id="hungerValue">100%</span>
                    </div>
                    <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="hungerBar" class="h-full bg-green-500 transition-all duration-300" style="width: 100%">
                        </div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Vui vẻ</span>
                        <span id="happinessValue">100%</span>
                    </div>
                    <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="happinessBar" class="h-full bg-yellow-500 transition-all duration-300"
                            style="width: 100%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Sạch sẽ</span>
                        <span id="cleanlinessValue">100%</span>
                    </div>
                    <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="cleanlinessBar" class="h-full bg-blue-500 transition-all duration-300"
                            style="width: 100%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Năng lượng</span>
                        <span id="energyValue">100%</span>
                    </div>
                    <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="energyBar" class="h-full bg-purple-500 transition-all duration-300"
                            style="width: 100%"></div>
                    </div>
                </div>
                <!-- Health status - only shows when sick -->
                <div id="healthStatus" class="hidden col-span-2">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Sức khỏe</span>
                        <span id="healthValue">50%</span>
                    </div>
                    <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="healthBar" class="h-full bg-red-500 transition-all duration-300" style="width: 50%">
                        </div>
                    </div>
                </div>
                <!-- Health status - only shows when sick -->
                <div id="healthStatus" class="hidden col-span-2">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Sức khỏe</span>
                        <span id="healthValue">50%</span>
                    </div>
                    <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="healthBar" class="h-full bg-red-500 transition-all duration-300" style="width: 50%"></div>
                    </div>
                </div>
            </div>

            <!-- Pet Display Area -->
            <div class="flex-1 flex flex-col items-center justify-center mb-4">
                <div id="petEnvironment" class="w-full h-60 rounded-xl overflow-hidden relative background-pattern">
                    <div id="dayNightCycle"
                        class="absolute inset-0 bg-gradient-to-b from-blue-300 to-transparent dark:from-indigo-900 dark:to-transparent opacity-40 transition-colors duration-1000">
                    </div>
                    <div id="petDisplayArea" class="absolute inset-0 flex items-center justify-center">
                        <div id="petContainer" class="relative w-40 h-40 flex items-center justify-center">
                            <div id="petShadow"
                                class="absolute bottom-0 w-32 h-8 bg-black/20 dark:bg-black/40 rounded-full"></div>
                            <div id="activePet" class="pet relative z-10"></div>
                            <!-- Food display container -->
                            <div id="foodContainer" class="absolute bottom-8 left-8 hidden">
                                <div id="foodItem" class="relative w-12 h-12 food-appear"></div>
                            </div>
                            <!-- Medicine effect container -->
                            <div id="medicineEffect" class="absolute inset-0 bg-green-500/20 rounded-full hidden"></div>
                        </div>
                    </div>
                    <div id="petEmotionBubble"
                        class="absolute top-10 right-10 bg-white dark:bg-gray-800 rounded-full p-2 shadow-lg hidden">
                        <span id="emotionIcon" class="text-2xl"></span>
                    </div>
                </div>
                <div id="petStatus" class="text-sm text-center mt-2 text-gray-600 dark:text-gray-300">Thú cưng đang thấy
                    rất vui!</div>
            </div>

            <!-- Interaction Buttons -->
            <div class="grid grid-cols-4 gap-3 mb-4">
<<<<<<< HEAD
                <button
                    class="action-btn flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition"
                    data-action="feed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
=======
                <button class="action-btn flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition" data-action="feed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    </svg>
                    <span class="text-xs mt-1">Cho ăn</span>
                </button>
                <button
                    class="action-btn flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition"
                    data-action="play">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs mt-1">Chơi</span>
                </button>
<<<<<<< HEAD
                <button
                    class="action-btn flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition"
                    data-action="clean">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 10v4m0 0v4m0-4h4m-4 0H10m11 -8.5v.5a4 4 0 0 1 -4 4h-1a2 2 0 0 0 -2 2v1a2 2 0 0 1 -2 2h-3c-.275 0-.5.225-.5.5v.5M3.5 12.5v-.5c0-.275.225-.5.5-.5h3a2 2 0 0 0 2-2v-1a2 2 0 0 1 2-2h1a4 4 0 0 0 4-4v-.5" />
=======
                <button class="action-btn flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition" data-action="clean">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10v4m0 0v4m0-4h4m-4 0H10m11 -8.5v.5a4 4 0 0 1 -4 4h-1a2 2 0 0 0 -2 2v1a2 2 0 0 1 -2 2h-3c-.275 0-.5.225-.5.5v.5M3.5 12.5v-.5c0-.275.225-.5.5-.5h3a2 2 0 0 0 2-2v-1a2 2 0 0 1 2-2h1a4 4 0 0 0 4-4v-.5" />
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    </svg>
                    <span class="text-xs mt-1">Tắm</span>
                </button>
                <button
                    class="action-btn flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition"
                    data-action="sleep">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <span class="text-xs mt-1" id="sleepButtonText">Ngủ</span>
                </button>
            </div>

            <!-- Stats and items -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold">Thống kê</h3>
                    <span id="timeDisplay" class="text-xs text-gray-500 dark:text-gray-400">Ngày 1 - 12:00</span>
                </div>
                <div class="grid grid-cols-2 gap-y-1 text-xs">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Tuổi: <span id="petAge">1</span> ngày</span>
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500 mr-1" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                        <span>Tình cảm: <span id="petLove">0</span></span>
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-1" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        <span>Kinh nghiệm: <span id="petXp">0</span>/100</span>
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500 mr-1" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Xu: <span id="petCoins">50</span></span>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
<<<<<<< HEAD
                    <button id="shopButton"
                        class="w-full bg-primary hover:bg-primary/80 text-white text-xs font-medium py-2 px-3 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
=======
                    <button id="shopButton" class="w-full bg-primary hover:bg-primary/80 text-white text-xs font-medium py-2 px-3 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                        </svg>
                        Cửa hàng
                    </button>
                </div>
            </div>
        </div>

        <!-- Food Selection Modal -->
        <div id="foodSelectionModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-5 max-w-sm w-full max-h-[90vh] flex flex-col shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Chọn Thức Ăn</h3>
<<<<<<< HEAD
                    <button id="closeFoodSelection"
                        class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
=======
                    <button id="closeFoodSelection" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 pr-1">
                    <div id="foodList" class="grid grid-cols-2 gap-3">
                        <!-- Food items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Shop Modal -->
        <div id="shopModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-5 max-w-sm w-full max-h-[90vh] flex flex-col shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Cửa Hàng</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium flex items-center">
<<<<<<< HEAD
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-1" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="shopCoins">50</span>
                        </span>
                        <button id="closeShop"
                            class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
=======
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="shopCoins">50</span>
                        </span>
                        <button id="closeShop" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                            </svg>
                        </button>
                    </div>
                </div>
<<<<<<< HEAD

=======
                
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                <!-- Shop Tabs -->
                <div class="mb-3 border-b border-gray-200 dark:border-gray-700">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <li class="mr-2">
<<<<<<< HEAD
                            <button
                                class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-primary text-primary"
                                data-tab="food">Thức ăn</button>
                        </li>
                        <li class="mr-2">
                            <button
                                class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-transparent hover:border-gray-300 dark:hover:border-gray-600"
                                data-tab="medicine">Thuốc</button>
                        </li>
                        <li class="mr-2">
                            <button
                                class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-transparent hover:border-gray-300 dark:hover:border-gray-600"
                                data-tab="minigames">Trò chơi</button>
                        </li>
                        <li>
                            <button
                                class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-transparent hover:border-gray-300 dark:hover:border-gray-600"
                                data-tab="toys">Đồ chơi</button>
                        </li>
                    </ul>
                </div>

=======
                            <button class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-primary text-primary" data-tab="food">Thức ăn</button>
                        </li>
                        <li class="mr-2">
                            <button class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-transparent hover:border-gray-300 dark:hover:border-gray-600" data-tab="medicine">Thuốc</button>
                        </li>
                        <li class="mr-2">
                            <button class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-transparent hover:border-gray-300 dark:hover:border-gray-600" data-tab="minigames">Trò chơi</button>
                        </li>
                        <li>
                            <button class="shop-tab inline-block p-2 border-b-2 rounded-t-lg border-transparent hover:border-gray-300 dark:hover:border-gray-600" data-tab="toys">Đồ chơi</button>
                        </li>
                    </ul>
                </div>
                
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                <!-- Tab Contents -->
                <div class="overflow-y-auto flex-1 pr-1">
                    <!-- Food Tab -->
                    <div id="foodTab" class="tab-content">
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Food items will be added here dynamically -->
                        </div>
                    </div>
<<<<<<< HEAD

=======
                    
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    <!-- Medicine Tab -->
                    <div id="medicineTab" class="tab-content hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Medicine items will be added here dynamically -->
                        </div>
                    </div>
<<<<<<< HEAD

=======
                    
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    <!-- Minigames Tab -->
                    <div id="minigamesTab" class="tab-content hidden">
                        <div class="grid grid-cols-1 gap-3">
                            <!-- Locked Minigames -->
                            <div id="lockedMinigames">
                                <h4 class="text-sm font-medium mb-2">Mở khóa trò chơi</h4>
                                <div class="grid grid-cols-1 gap-3">
                                    <!-- Minigame items will be added here dynamically -->
                                </div>
                            </div>
<<<<<<< HEAD

=======
                            
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                            <!-- Unlocked Minigames -->
                            <div id="unlockedMinigames" class="mt-4">
                                <h4 class="text-sm font-medium mb-2">Đã mở khóa</h4>
                                <div class="grid grid-cols-1 gap-3">
                                    <!-- Unlocked minigame items will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
<<<<<<< HEAD

=======
                    
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    <!-- Toys Tab -->
                    <div id="toysTab" class="tab-content hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Toy items will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Minigame Screen -->
        <div id="minigameScreen" class="hidden flex-1 flex flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 id="minigameTitle" class="text-xl font-bold text-primary">Minigame</h2>
                <button id="closeMinigame"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Minigame Selection -->
            <div id="minigameSelection" class="grid grid-cols-2 gap-4">
                <div class="minigame-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow"
                    data-game="ballcatch">
                    <div
                        class="bg-blue-100 dark:bg-blue-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Bắt Bóng</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Giúp thú cưng của bạn bắt những
                        quả bóng</p>
                </div>
                <div class="minigame-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow"
                    data-game="memory">
                    <div
                        class="bg-purple-100 dark:bg-purple-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-purple-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Trò Chơi Trí Nhớ</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Lật các thẻ bài và tìm cặp
                        giống nhau</p>
                </div>
                <div class="minigame-card bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow"
                    data-game="training">
                    <div
                        class="bg-green-100 dark:bg-green-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Huấn Luyện Thú Cưng</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Dạy thú cưng thực hiện các động
                        tác</p>
                </div>
                <!-- New unlockable minigames (hidden by default, shown when unlocked) -->
                <div id="puzzleGameCard"
                    class="minigame-card hidden bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow"
                    data-game="puzzle">
                    <div
                        class="bg-red-100 dark:bg-red-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Xếp Hình</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Giải các câu đố xếp hình cùng
                        thú cưng của bạn</p>
                </div>
                <div id="raceGameCard"
                    class="minigame-card hidden bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow"
                    data-game="race">
                    <div
                        class="bg-yellow-100 dark:bg-yellow-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Đua Thú Cưng</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Tham gia các cuộc đua và chiến
                        thắng các thú cưng khác</p>
                </div>
                <!-- New unlockable minigames (hidden by default, shown when unlocked) -->
                <div id="puzzleGameCard" class="minigame-card hidden bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow" data-game="puzzle">
                    <div class="bg-red-100 dark:bg-red-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Xếp Hình</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Giải các câu đố xếp hình cùng thú cưng của bạn</p>
                </div>
                <div id="raceGameCard" class="minigame-card hidden bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow" data-game="race">
                    <div class="bg-yellow-100 dark:bg-yellow-900/30 w-16 h-16 rounded-full flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-bold">Đua Thú Cưng</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">Tham gia các cuộc đua và chiến thắng các thú cưng khác</p>
                </div>
            </div>

            <!-- Ball Catch Game -->
            <div id="ballCatchGame" class="hidden flex-1 flex flex-col">
                <!-- Instructions Panel -->
                <div id="ballCatchInstructions" class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-4 shadow-md">
                    <h3 class="font-bold text-center mb-2">Hướng dẫn chơi</h3>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="flex items-center">
                            <div class="w-5 h-5 rounded-full bg-yellow-400 mr-2"></div>
                            <span class="text-xs">Bóng thường (1 điểm)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-5 h-5 rounded-full bg-red-500 mr-2"></div>
                            <span class="text-xs">Bóng đặc biệt (3 điểm)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-5 h-5 rounded-full bg-blue-500 mr-2"></div>
                            <span class="text-xs">Đóng băng các bóng khác</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-5 h-5 rounded-full bg-green-500 mr-2"></div>
                            <span class="text-xs">Thú cưng giúp bắt bóng</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-5 h-5 rounded-full bg-black mr-2"></div>
                            <span class="text-xs">Đánh rơi = 3 lỗi</span>
                        </div>
                    </div>
                    <p class="text-xs text-center">Trận đấu kết thúc khi bạn bỏ lỡ 10 quả bóng.<br>Bóng sẽ rơi nhanh hơn
                        và đặc biệt hơn khi trò chơi tiếp tục!</p>
                </div>

                <div class="mb-4 flex justify-between items-center">
                    <div class="flex space-x-4">
                        <div class="text-sm">Điểm: <span id="ballCatchScore" class="font-bold">0</span></div>
                        <div class="text-sm">Thời gian: <span id="ballCatchTimer" class="font-bold">0</span>s</div>
                    </div>
                    <div class="text-sm bg-red-100 dark:bg-red-900/30 px-2 py-1 rounded-md">
                        Lỗi: <span id="ballCatchMissed" class="font-bold">0</span>/10
                    </div>
                </div>

                <div id="ballCatchArea"
                    class="relative flex-1 bg-blue-100 dark:bg-blue-900/30 rounded-lg overflow-hidden mb-4 border-2 border-blue-200 dark:border-blue-800">
                    <!-- Game Effects -->
                    <div id="freezeEffect"
                        class="absolute inset-0 bg-blue-300 dark:bg-blue-700 opacity-30 hidden pointer-events-none z-10">
                    </div>
                    <div id="petHelperEffect"
                        class="absolute inset-0 bg-green-300 dark:bg-green-700 opacity-20 hidden pointer-events-none z-10">
                    </div>

                    <!-- Pet Character -->
                    <div id="ballCatchPet" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-20 h-20 z-20">
                    </div>

                    <!-- Helper Pet -->
                    <div id="helperPet" class="absolute bottom-4 right-10 w-16 h-16 hidden z-20"></div>

                    <!-- Status Indicators -->
                    <div id="statusEffects" class="absolute top-2 left-2 flex space-x-2 z-30">
                        <div id="freezeStatus" class="hidden px-2 py-1 bg-blue-500 text-white text-xs rounded-full">
                            Đóng băng: <span id="freezeTime">0</span>s
                        </div>
                        <div id="helperStatus" class="hidden px-2 py-1 bg-green-500 text-white text-xs rounded-full">
                            Hỗ trợ: <span id="helperTime">0</span>s
                        </div>
                    </div>
                </div>

                <button id="startBallCatch"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                    Bắt đầu
                </button>
            </div>

            <!-- Memory Game -->
            <div id="memoryGame" class="hidden flex-1 flex flex-col">
                <div class="mb-4 flex justify-between items-center">
                    <div class="text-sm">Cặp đã tìm: <span id="memoryPairs">0</span>/8</div>
                    <div class="text-sm">Lượt lật: <span id="memoryMoves">0</span></div>
                </div>
                <div id="memoryBoard" class="grid grid-cols-4 gap-2 flex-1 mb-4">
                    <!-- Memory cards will be added here -->
                </div>
                <button id="resetMemoryGame"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded-lg">
                    Chơi lại
                </button>
            </div>

            <!-- Pet Training Game -->
            <div id="trainingGame" class="hidden flex-1 flex flex-col">
                <div class="mb-4 text-center">
                    <div id="trainingCommand" class="text-lg font-bold mb-2">Đợi lệnh...</div>
                    <div id="trainingInstructions" class="text-sm text-gray-600 dark:text-gray-400">Chọn đúng nút lệnh
                        khi được yêu cầu!</div>
                </div>
                <div id="trainingArea"
                    class="relative flex-1 bg-green-50 dark:bg-green-900/20 rounded-lg overflow-hidden mb-4 flex items-center justify-center">
                    <div id="trainingPet" class="w-32 h-32"></div>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button
                        class="training-btn bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 py-2 rounded-lg text-sm font-medium"
                        data-command="sit">Ngồi xuống</button>
                    <button
                        class="training-btn bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 py-2 rounded-lg text-sm font-medium"
                        data-command="roll">Lăn tròn</button>
                    <button
                        class="training-btn bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 py-2 rounded-lg text-sm font-medium"
                        data-command="jump">Nhảy lên</button>
                </div>
                <button id="startTraining"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded-lg">
                    Bắt đầu huấn luyện
                </button>
            </div>

            <!-- Puzzle Game (New) -->
            <div id="puzzleGame" class="hidden flex-1 flex flex-col">
                <div class="mb-4 flex justify-between items-center">
                    <div class="text-sm">Di chuyển: <span id="puzzleMoves">0</span></div>
                    <div class="text-sm">Thời gian: <span id="puzzleTimer">0</span>s</div>
                </div>
<<<<<<< HEAD
                <div id="puzzleBoard"
                    class="grid grid-cols-3 gap-1 aspect-square w-full max-w-xs mx-auto mb-4 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
                    <!-- Puzzle tiles will be added here -->
                </div>
                <div class="flex space-x-2">
                    <button id="resetPuzzle"
                        class="flex-1 bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded-lg">
                        Chơi lại
                    </button>
                    <select id="puzzleDifficulty"
                        class="flex-1 text-base bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-4">
=======
                <div id="puzzleBoard" class="grid grid-cols-3 gap-1 aspect-square w-full max-w-xs mx-auto mb-4 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
                    <!-- Puzzle tiles will be added here -->
                </div>
                <div class="flex space-x-2">
                    <button id="resetPuzzle" class="flex-1 bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded-lg">
                        Chơi lại
                    </button>
                    <select id="puzzleDifficulty" class="flex-1 text-base bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-4">
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                        <option value="3">Dễ (3x3)</option>
                        <option value="4">Trung bình (4x4)</option>
                        <option value="5">Khó (5x5)</option>
                    </select>
                </div>
            </div>

            <!-- Pet Race Game (New) -->
            <div id="raceGame" class="hidden flex-1 flex flex-col">
                <div class="mb-2 flex justify-between items-center">
                    <div class="text-sm font-medium">Vòng đua: <span id="raceRound">1</span>/3</div>
                    <div class="text-sm font-medium">Vị trí: <span id="racePosition">?</span>/4</div>
                </div>
<<<<<<< HEAD
                <div id="raceTrack"
                    class="relative flex-1 bg-green-100 dark:bg-green-900/30 rounded-lg overflow-hidden mb-4 border-2 border-green-200 dark:border-green-800">
=======
                <div id="raceTrack" class="relative flex-1 bg-green-100 dark:bg-green-900/30 rounded-lg overflow-hidden mb-4 border-2 border-green-200 dark:border-green-800">
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    <!-- Track lanes -->
                    <div class="absolute inset-0 flex flex-col">
                        <div class="border-b border-dashed border-green-500 h-1/4"></div>
                        <div class="border-b border-dashed border-green-500 h-1/4"></div>
                        <div class="border-b border-dashed border-green-500 h-1/4"></div>
                        <div class="h-1/4"></div>
                    </div>
<<<<<<< HEAD

                    <!-- Finish line -->
                    <div class="absolute right-0 top-0 bottom-0 w-1 bg-red-500"></div>

=======
                    
                    <!-- Finish line -->
                    <div class="absolute right-0 top-0 bottom-0 w-1 bg-red-500"></div>
                    
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    <!-- Pet racers will be added here -->
                    <div id="playerPet" class="absolute left-4 top-[12.5%] -translate-y-1/2 w-16 h-16"></div>
                    <div id="npcPet1" class="absolute left-4 top-[37.5%] -translate-y-1/2 w-16 h-16"></div>
                    <div id="npcPet2" class="absolute left-4 top-[62.5%] -translate-y-1/2 w-16 h-16"></div>
                    <div id="npcPet3" class="absolute left-4 top-[87.5%] -translate-y-1/2 w-16 h-16"></div>
                </div>
<<<<<<< HEAD

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div id="boostMeter" class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="boostBar" class="h-full bg-yellow-500 transition-all duration-300" style="width: 100%">
                        </div>
                    </div>
                    <button id="boostButton"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-4 rounded-lg disabled:opacity-50">
                        Tăng tốc!
                    </button>
                </div>

                <button id="startRace"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:scale-105">
=======
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div id="boostMeter" class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="boostBar" class="h-full bg-yellow-500 transition-all duration-300" style="width: 100%"></div>
                    </div>
                    <button id="boostButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-4 rounded-lg disabled:opacity-50">
                        Tăng tốc!
                    </button>
                </div>
                
                <button id="startRace" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:scale-105">
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
                    Bắt đầu đua
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-5 max-w-sm w-full shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Cài Đặt</h3>
                    <button id="closeSettings"
                        class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span>Âm thanh</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="soundToggle" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Thông báo</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="notificationToggle" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>
                    <div>
                        <label for="gameSpeed" class="block mb-1">Tốc độ giảm chỉ số</label>
                        <select id="gameSpeed"
                            class="text-base w-full p-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700">
                            <option value="slow">Chậm</option>
                            <option value="normal" selected>Bình thường</option>
                            <option value="fast">Nhanh</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Tự động lưu</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoSaveToggle" class="sr-only peer" checked>
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>
                    <div class="flex space-x-2">
                        <button id="resetGameButton"
                            class="w-1/2 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg">
                            Bắt đầu lại
                        </button>
                        <button id="saveGameButton"
                            class="w-1/2 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">
                            Lưu thủ công
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<<<<<<< HEAD
    <!-- Load all the JavaScript files in the correct order -->
    <script src="assets/js/game-state.js"></script>
    <script src="assets/js/pets.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/shop.js"></script>
    <script src="assets/js/minigames/ball-catch.js"></script>
    <script src="assets/js/minigames/memory.js"></script>
    <script src="assets/js/minigames/training.js"></script>
    <script src="assets/js/minigames/puzzle.js"></script>
    <script src="assets/js/minigames/race.js"></script>
    <script src="assets/js/main.js"></script>
=======
    <script>
        // Check dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Pet drawing functions
        function drawCat(element) {
            const cat = document.createElement('div');
            cat.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-20 h-16">
                        <div class="absolute w-18 h-14 bg-amber-200 dark:bg-amber-300 rounded-full top-2 left-1"></div>
                        <div class="absolute top-0 left-0 w-8 h-8 bg-amber-200 dark:bg-amber-300 rounded-full transform -translate-x-1/4 translate-y-1/4 flex items-center justify-center">
                            <div class="w-4 h-4 bg-black/80 rounded-full"></div>
                        </div>
                        <div class="absolute top-0 right-0 w-8 h-8 bg-amber-200 dark:bg-amber-300 rounded-full transform translate-x-1/4 translate-y-1/4 flex items-center justify-center">
                            <div class="w-4 h-4 bg-black/80 rounded-full"></div>
                        </div>
                        <div class="absolute top-8 left-1/2 -translate-x-1/2 w-3 h-2 bg-pink-300 dark:bg-pink-400 rounded-full"></div>
                        <div class="absolute top-6 left-1/2 -translate-x-1/2 w-4 h-4 bg-pink-50 dark:bg-pink-100 rounded-full"></div>
                        <div class="absolute top-12 left-1/2 -translate-x-1/2 w-6 h-1 flex items-center space-x-1">
                            <div class="w-1 h-3 bg-black transform -translate-y-0.5 rotate-12"></div>
                            <div class="w-1 h-3 bg-black transform -translate-y-0.5 -rotate-12"></div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-10 bg-amber-200 dark:bg-amber-300 rounded-full"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(cat);
        }

        function drawRabbit(element) {
            const rabbit = document.createElement('div');
            rabbit.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-4 left-1/2 -translate-x-1/2 w-16 h-16">
                        <div class="absolute w-16 h-16 bg-gray-100 dark:bg-gray-200 rounded-full"></div>
                        <div class="absolute top-0 left-0 w-6 h-12 bg-gray-100 dark:bg-gray-200 rounded-full transform -translate-x-1/2 -translate-y-3/4 -rotate-12"></div>
                        <div class="absolute top-0 right-0 w-6 h-12 bg-gray-100 dark:bg-gray-200 rounded-full transform translate-x-1/2 -translate-y-3/4 rotate-12"></div>
                        <div class="absolute top-4 left-1/4 w-3 h-3 bg-pink-200 dark:bg-pink-300 rounded-full"></div>
                        <div class="absolute top-4 right-1/4 w-3 h-3 bg-pink-200 dark:bg-pink-300 rounded-full"></div>
                        <div class="absolute top-8 left-1/2 -translate-x-1/2 w-2 h-2 bg-pink-300 dark:bg-pink-400 rounded-full"></div>
                        <div class="absolute top-6 left-1/2 -translate-x-1/2 w-4 h-4 bg-white dark:bg-gray-50 rounded-full"></div>
                        <div class="absolute top-10 left-1/2 -translate-x-1/2 w-4 h-1 flex items-center space-x-1">
                            <div class="w-1 h-2 bg-black"></div>
                            <div class="w-1 h-2 bg-black"></div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-8 bg-gray-100 dark:bg-gray-200 rounded-full"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(rabbit);
        }

        function drawDinosaur(element) {
            const dino = document.createElement('div');
            dino.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-4 left-1/2 -translate-x-1/2 w-16 h-14">
                        <div class="absolute w-14 h-12 bg-green-300 dark:bg-green-400 rounded-full top-1 left-1"></div>
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-10 h-3 flex justify-around">
                            <div class="w-2 h-3 bg-green-300 dark:bg-green-400 rounded-sm"></div>
                            <div class="w-2 h-4 bg-green-300 dark:bg-green-400 rounded-sm"></div>
                            <div class="w-2 h-2 bg-green-300 dark:bg-green-400 rounded-sm"></div>
                        </div>
                        <div class="absolute top-4 left-1/4 w-3 h-3 bg-white dark:bg-gray-50 rounded-full flex items-center justify-center">
                            <div class="w-2 h-2 bg-black rounded-full"></div>
                        </div>
                        <div class="absolute top-4 right-1/4 w-3 h-3 bg-white dark:bg-gray-50 rounded-full flex items-center justify-center">
                            <div class="w-2 h-2 bg-black rounded-full"></div>
                        </div>
                        <div class="absolute top-8 left-1/2 -translate-x-1/2 w-5 h-2 bg-green-400 dark:bg-green-500 rounded-full"></div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-8 bg-green-300 dark:bg-green-400 rounded-t-lg"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(dino);
        }

        function drawPanda(element) {
            const panda = document.createElement('div');
            panda.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-20 h-16">
                        <div class="absolute w-16 h-14 bg-white dark:bg-gray-100 rounded-full top-1 left-2"></div>
                        <div class="absolute top-0 left-0 w-8 h-8 bg-black rounded-full transform -translate-x-1/4 translate-y-1/4 flex items-center justify-center">
                            <div class="w-4 h-4 bg-white dark:bg-gray-100 rounded-full"></div>
                        </div>
                        <div class="absolute top-0 right-0 w-8 h-8 bg-black rounded-full transform translate-x-1/4 translate-y-1/4 flex items-center justify-center">
                            <div class="w-4 h-4 bg-white dark:bg-gray-100 rounded-full"></div>
                        </div>
                        <div class="absolute top-8 left-1/2 -translate-x-1/2 w-3 h-2 bg-black rounded-full"></div>
                        <div class="absolute top-10 left-1/2 -translate-x-1/2 w-6 h-1 flex items-center space-x-1">
                            <div class="w-1 h-2 bg-black"></div>
                            <div class="w-1 h-2 bg-black"></div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-10 bg-black rounded-full"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(panda);
        }

        function drawDog(element) {
            const dog = document.createElement('div');
            dog.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-20 h-16">
                        <div class="absolute w-16 h-14 bg-amber-600 dark:bg-amber-700 rounded-full top-1 left-2"></div>
                        <div class="absolute top-0 left-0 w-7 h-5 bg-amber-600 dark:bg-amber-700 rounded-full transform -translate-x-1/2 rotate-20"></div>
                        <div class="absolute top-0 right-0 w-7 h-5 bg-amber-600 dark:bg-amber-700 rounded-full transform translate-x-1/2 -rotate-20"></div>
                        <div class="absolute top-4 left-1/4 w-3 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-4 right-1/4 w-3 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-8 left-1/2 -translate-x-1/2 w-4 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-10 left-1/2 -translate-x-1/2 w-6 h-2 bg-pink-300 dark:bg-pink-400 rounded"></div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-14 h-8 bg-amber-600 dark:bg-amber-700 rounded-full"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(dog);
        }

        function drawBird(element) {
            const bird = document.createElement('div');
            bird.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-16 h-16">
                        <div class="absolute w-16 h-14 bg-red-400 dark:bg-red-500 rounded-full top-1 left-0"></div>
                        <div class="absolute top-4 left-1/4 w-3 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-4 right-1/4 w-3 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-1 left-1/2 -translate-x-1/2 w-8 h-2 bg-red-500 dark:bg-red-600"></div>
                        <div class="absolute top-6 left-1/2 -translate-x-1/2 transform rotate-20 w-6 h-4 bg-yellow-400 dark:bg-yellow-500" style="clip-path: polygon(0% 50%, 50% 0%, 100% 50%, 50% 100%);"></div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-10 h-6 bg-red-400 dark:bg-red-500 rounded-full"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(bird);
        }

        function drawFish(element) {
            const fish = document.createElement('div');
            fish.innerHTML = `
                <div class="w-full h-full relative pet-float">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-12">
                        <div class="absolute w-16 h-10 bg-orange-400 dark:bg-orange-500 rounded-full top-1 left-0"></div>
                        <div class="absolute top-1 right-0 w-8 h-10 bg-orange-400 dark:bg-orange-500" style="clip-path: polygon(0% 0%, 0% 100%, 100% 50%);"></div>
                        <div class="absolute top-3 left-4 w-3 h-3 bg-white dark:bg-gray-100 rounded-full">
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-black rounded-full"></div>
                        </div>
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-4 bg-orange-500 dark:bg-orange-600" style="clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                    </div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(fish);
        }

        function drawHamster(element) {
            const hamster = document.createElement('div');
            hamster.innerHTML = `
                <div class="w-full h-full relative">
                    <div class="absolute top-2 left-1/2 -translate-x-1/2 w-16 h-14">
                        <div class="absolute w-16 h-14 bg-amber-300 dark:bg-amber-400 rounded-full"></div>
                        <div class="absolute top-3 left-1/4 w-3 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-3 right-1/4 w-3 h-3 bg-black rounded-full"></div>
                        <div class="absolute top-0 left-0 w-4 h-4 bg-amber-300 dark:bg-amber-400 rounded-full transform -translate-x-1/3 -translate-y-1/4"></div>
                        <div class="absolute top-0 right-0 w-4 h-4 bg-amber-300 dark:bg-amber-400 rounded-full transform translate-x-1/3 -translate-y-1/4"></div>
                        <div class="absolute top-7 left-1/2 -translate-x-1/2 w-5 h-3 bg-pink-200 dark:bg-pink-300 rounded-full"></div>
                        <div class="absolute top-6 left-1/2 -translate-x-1/2 w-6 h-2 flex justify-around items-center">
                            <div class="w-1 h-2 bg-black rounded-full"></div>
                            <div class="w-1 h-2 bg-black rounded-full"></div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-6 bg-amber-300 dark:bg-amber-400 rounded-full"></div>
                </div>
            `;
            element.innerHTML = '';
            element.appendChild(hamster);
        }

        // Game logic
        document.addEventListener('DOMContentLoaded', function() {
            // Toast notification
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            function showToast(message, duration = 3000) {
                toastMessage.textContent = message;
                toast.classList.add('visible');
                setTimeout(() => {
                    toast.classList.remove('visible');
                }, duration);
            }

            // Internal game state
            const gameState = {
                selectedPet: null,
                petName: '',
                stats: {
                    hunger: 100,
                    happiness: 100,
                    cleanliness: 100,
                    energy: 100,
                    health: 100,  // New health stat
                    age: 1,
                    love: 0,
                    xp: 0,
                    coins: 50,
                    level: 1,
                    isSick: false  // New sickness state
                },
                timers: {
                    statsInterval: null,
                    dayInterval: null,
                    autoSaveInterval: null,
                    sickInterval: null  // New sickness check interval
                },
                settings: {
                    sound: true,
                    notification: true,
                    gameSpeed: 'normal',
                    autoSave: true
                },
                gameTime: {
                    day: 1,
                    hour: 12,
                    minute: 0
                },
                minigames: {
                    ballCatch: {
                        highScore: 0,
                        playCount: 0
                    },
                    memory: {
                        bestMoves: 0,
                        playCount: 0 
                    },
                    training: {
                        commandsLearned: 0,
                        playCount: 0
                    },
                    puzzle: {
                        highScore: 0,
                        playCount: 0,
                        unlocked: false
                    },
                    race: {
                        wins: 0,
                        playCount: 0,
                        unlocked: false
                    }
                },
                inventory: {
                    food: [],
                    medicine: [],
                    toys: []
                },
                isAsleep: false,
                isPaused: false,
                lastSaved: null,
                // Food preferences by pet type
                foodPreferences: [
                    {type: 0, preferences: [0, 6, 7]},  // Cat: Fish, Cat Food, Milk
                    {type: 1, preferences: [1, 8, 5]},  // Rabbit: Carrot, Lettuce, Fruit
                    {type: 2, preferences: [2, 9, 5]},  // Dinosaur: Meat, Leaves, Fruit
                    {type: 3, preferences: [3, 8, 1]},  // Panda: Bamboo, Lettuce, Carrot
                    {type: 4, preferences: [4, 10, 2]}, // Dog: Dog Food, Bone, Meat
                    {type: 5, preferences: [5, 1, 8]},  // Bird: Fruit, Carrot, Lettuce
                    {type: 6, preferences: [6, 0, 7]},  // Fish: Fish Food, Fish, Milk
                    {type: 7, preferences: [7, 5, 1]}   // Hamster: Seeds, Fruit, Carrot
                ]
            };

            // Food items definition
            const foodItems = [
                { id: 0, name: "Cá", price: 15, hunger: 20, happiness: 5, img: "🐟", quality: 2, risk: 0.02 },
                { id: 1, name: "Cà rốt", price: 8, hunger: 15, happiness: 3, img: "🥕", quality: 1, risk: 0.01 },
                { id: 2, name: "Thịt", price: 25, hunger: 30, happiness: 5, img: "🍖", quality: 3, risk: 0.03 },
                { id: 3, name: "Măng tre", price: 20, hunger: 25, happiness: 4, img: "🎋", quality: 2, risk: 0.01 },
                { id: 4, name: "Thức ăn cho chó", price: 10, hunger: 20, happiness: 4, img: "🥫", quality: 2, risk: 0.01 },
                { id: 5, name: "Trái cây", price: 12, hunger: 15, happiness: 6, img: "🍎", quality: 2, risk: 0.01 },
                { id: 6, name: "Thức ăn cho cá", price: 5, hunger: 15, happiness: 3, img: "🦐", quality: 1, risk: 0.02 },
                { id: 7, name: "Hạt", price: 7, hunger: 15, happiness: 3, img: "🌰", quality: 1, risk: 0.01 },
                { id: 8, name: "Rau xanh", price: 10, hunger: 20, happiness: 3, img: "🥬", quality: 1, risk: 0.01 },
                { id: 9, name: "Lá cây", price: 5, hunger: 10, happiness: 2, img: "🍃", quality: 1, risk: 0.01 },
                { id: 10, name: "Xương", price: 8, hunger: 10, happiness: 5, img: "🦴", quality: 1, risk: 0.02 },
                { id: 11, name: "Thức ăn cao cấp", price: 30, hunger: 40, happiness: 10, img: "🍱", quality: 3, risk: 0 },
                { id: 12, name: "Bánh thưởng", price: 15, hunger: 10, happiness: 15, img: "🍪", quality: 2, risk: 0.01 }
            ];

            // Medicine items definition
            const medicineItems = [
                { id: 0, name: "Thuốc cơ bản", price: 20, healing: 30, img: "💊", description: "Giúp hồi phục 30% sức khỏe" },
                { id: 1, name: "Thuốc kháng sinh", price: 50, healing: 70, img: "💉", description: "Giúp hồi phục 70% sức khỏe" },
                { id: 2, name: "Thuốc toàn diện", price: 100, healing: 100, img: "🧪", description: "Hồi phục 100% sức khỏe" },
                { id: 3, name: "Vitamin", price: 30, healing: 20, img: "🍯", description: "Tăng 20% sức khỏe và giảm nguy cơ bệnh" }
            ];

            // Toy items definition
            const toyItems = [
                { id: 0, name: "Bóng", price: 15, happiness: 10, img: "⚽", description: "Tăng 10 điểm vui vẻ" },
                { id: 1, name: "Chuông", price: 20, happiness: 15, img: "🔔", description: "Tăng 15 điểm vui vẻ" },
                { id: 2, name: "Gấu bông", price: 25, happiness: 20, img: "🧸", description: "Tăng 20 điểm vui vẻ" },
                { id: 3, name: "Cần câu cá", price: 30, happiness: 25, img: "🎣", description: "Tăng 25 điểm vui vẻ" }
            ];

            // Minigame items in the shop
            const minigameItems = [
                { id: 0, name: "Xếp Hình", price: 100, img: "🧩", description: "Mở khóa trò chơi Xếp Hình", game: "puzzle" },
                { id: 1, name: "Đua Thú Cưng", price: 100, img: "🏁", description: "Mở khóa trò chơi Đua Thú Cưng", game: "race" }
            ];

            // Speed multipliers
            const speedMultipliers = {
                slow: 0.5,
                normal: 1,
                fast: 2
            };

            // DOM Elements
            const welcomeScreen = document.getElementById('welcomeScreen');
            const petSelectionScreen = document.getElementById('petSelectionScreen');
            const gameScreen = document.getElementById('gameScreen');
            const minigameScreen = document.getElementById('minigameScreen');
            const settingsModal = document.getElementById('settingsModal');
            const foodSelectionModal = document.getElementById('foodSelectionModal');
            const shopModal = document.getElementById('shopModal');
            
            const startButton = document.getElementById('startButton');
            const continueButton = document.getElementById('continueButton');
            const adoptButton = document.getElementById('adoptButton');
            const petCards = document.querySelectorAll('.pet-card');
            const petNameInput = document.getElementById('petName');
            
            const actionButtons = document.querySelectorAll('.action-btn');
            const settingsButton = document.getElementById('settingsButton');
            const closeSettings = document.getElementById('closeSettings');
            const resetGameButton = document.getElementById('resetGameButton');
            const saveGameButton = document.getElementById('saveGameButton');
            
            const soundToggle = document.getElementById('soundToggle');
            const notificationToggle = document.getElementById('notificationToggle');
            const gameSpeedSelect = document.getElementById('gameSpeed');
            const autoSaveToggle = document.getElementById('autoSaveToggle');
            
            const petGameName = document.getElementById('petGameName');
            const petLevel = document.getElementById('petLevel');
            const petAge = document.getElementById('petAge');
            const petLove = document.getElementById('petLove');
            const petXp = document.getElementById('petXp');
            const petCoins = document.getElementById('petCoins');
            const timeDisplay = document.getElementById('timeDisplay');
            
            const hungerBar = document.getElementById('hungerBar');
            const happinessBar = document.getElementById('happinessBar');
            const cleanlinessBar = document.getElementById('cleanlinessBar');
            const energyBar = document.getElementById('energyBar');
            const healthBar = document.getElementById('healthBar');
            
            const hungerValue = document.getElementById('hungerValue');
            const happinessValue = document.getElementById('happinessValue');
            const cleanlinessValue = document.getElementById('cleanlinessValue');
            const energyValue = document.getElementById('energyValue');
            const healthValue = document.getElementById('healthValue');
            const healthStatus = document.getElementById('healthStatus');
            
            const petStatus = document.getElementById('petStatus');
            const emotionBubble = document.getElementById('petEmotionBubble');
            const emotionIcon = document.getElementById('emotionIcon');
            const activePet = document.getElementById('activePet');
            const sleepButtonText = document.getElementById('sleepButtonText');
            const foodContainer = document.getElementById('foodContainer');
            const foodItem = document.getElementById('foodItem');
            const medicineEffect = document.getElementById('medicineEffect');

            // Food Selection Elements
            const closeFoodSelection = document.getElementById('closeFoodSelection');
            const foodList = document.getElementById('foodList');

            // Shop Elements
            const shopButton = document.getElementById('shopButton');
            const closeShop = document.getElementById('closeShop');
            const shopCoins = document.getElementById('shopCoins');
            const shopTabs = document.querySelectorAll('.shop-tab');
            const foodTab = document.getElementById('foodTab');
            const medicineTab = document.getElementById('medicineTab');
            const minigamesTab = document.getElementById('minigamesTab');
            const toysTab = document.getElementById('toysTab');
            const lockedMinigames = document.getElementById('lockedMinigames');
            const unlockedMinigames = document.getElementById('unlockedMinigames');

            // Minigame elements
            const minigameCards = document.querySelectorAll('.minigame-card');
            const minigameSelection = document.getElementById('minigameSelection');
            const closeMinigame = document.getElementById('closeMinigame');
            const minigameTitle = document.getElementById('minigameTitle');
            const puzzleGameCard = document.getElementById('puzzleGameCard');
            const raceGameCard = document.getElementById('raceGameCard');
            
            // Ball Catch Game
            const ballCatchGame = document.getElementById('ballCatchGame');
            const ballCatchArea = document.getElementById('ballCatchArea');
            const ballCatchPet = document.getElementById('ballCatchPet');
            const ballCatchScore = document.getElementById('ballCatchScore');
            const ballCatchTimer = document.getElementById('ballCatchTimer');
            const ballCatchMissed = document.getElementById('ballCatchMissed');
            const startBallCatch = document.getElementById('startBallCatch');
            const freezeEffect = document.getElementById('freezeEffect');
            const petHelperEffect = document.getElementById('petHelperEffect');
            const helperPetElement = document.getElementById('helperPet');
            const freezeStatus = document.getElementById('freezeStatus');
            const helperStatus = document.getElementById('helperStatus');
            const freezeTime = document.getElementById('freezeTime');
            const helperTime = document.getElementById('helperTime');
            
            // Memory Game
            const memoryGame = document.getElementById('memoryGame');
            const memoryBoard = document.getElementById('memoryBoard');
            const memoryPairs = document.getElementById('memoryPairs');
            const memoryMoves = document.getElementById('memoryMoves');
            const resetMemoryGame = document.getElementById('resetMemoryGame');
            
            // Training Game
            const trainingGame = document.getElementById('trainingGame');
            const trainingCommand = document.getElementById('trainingCommand');
            const trainingInstructions = document.getElementById('trainingInstructions');
            const trainingArea = document.getElementById('trainingArea');
            const trainingPet = document.getElementById('trainingPet');
            const trainingButtons = document.querySelectorAll('.training-btn');
            const startTraining = document.getElementById('startTraining');

            // Puzzle Game
            const puzzleGame = document.getElementById('puzzleGame');
            const puzzleBoard = document.getElementById('puzzleBoard');
            const puzzleMoves = document.getElementById('puzzleMoves');
            const puzzleTimer = document.getElementById('puzzleTimer');
            const resetPuzzle = document.getElementById('resetPuzzle');
            const puzzleDifficulty = document.getElementById('puzzleDifficulty');

            // Race Game
            const raceGame = document.getElementById('raceGame');
            const raceTrack = document.getElementById('raceTrack');
            const raceRound = document.getElementById('raceRound');
            const racePosition = document.getElementById('racePosition');
            const playerPet = document.getElementById('playerPet');
            const npcPet1 = document.getElementById('npcPet1');
            const npcPet2 = document.getElementById('npcPet2');
            const npcPet3 = document.getElementById('npcPet3');
            const boostBar = document.getElementById('boostBar');
            const boostButton = document.getElementById('boostButton');
            const startRace = document.getElementById('startRace');
            
            // Initialize pet previews
            const pet1 = document.getElementById('pet1');
            const pet2 = document.getElementById('pet2');
            const pet3 = document.getElementById('pet3');
            const pet4 = document.getElementById('pet4');
            const pet5 = document.getElementById('pet5');
            const pet6 = document.getElementById('pet6');
            const pet7 = document.getElementById('pet7');
            const pet8 = document.getElementById('pet8');
            const welcomePet = document.getElementById('welcomePet');
            
            drawCat(pet1);
            drawRabbit(pet2);
            drawDinosaur(pet3);
            drawPanda(pet4);
            drawDog(pet5);
            drawBird(pet6);
            drawFish(pet7);
            drawHamster(pet8);
            
            // Create SVG for welcome pet (rotating every few seconds)
            let currentWelcomePet = 0;
            const welcomePets = [drawCat, drawRabbit, drawDinosaur, drawPanda, drawDog, drawBird, drawFish, drawHamster];
            
            function rotateWelcomePet() {
                currentWelcomePet = (currentWelcomePet + 1) % welcomePets.length;
                welcomePets[currentWelcomePet](welcomePet);
            }
            
            // Initial welcome pet
            rotateWelcomePet();
            // Rotate every 3 seconds
            setInterval(rotateWelcomePet, 3000);

            // Check if localStorage is available
            function isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // Save and Load game state
            function saveGameState() {
                if (!isLocalStorageAvailable()) {
                    console.log("LocalStorage not available. Cannot save game state.");
                    return false;
                }

                try {
                    const saveData = {
                        selectedPet: gameState.selectedPet,
                        petName: gameState.petName,
                        stats: gameState.stats,
                        settings: gameState.settings,
                        gameTime: gameState.gameTime,
                        minigames: gameState.minigames,
                        inventory: gameState.inventory,
                        isAsleep: gameState.isAsleep,
                        lastSaved: new Date().toISOString()
                    };

                    localStorage.setItem('virtualPetData', JSON.stringify(saveData));
                    gameState.lastSaved = saveData.lastSaved;
                    return true;
                } catch (e) {
                    console.error("Error saving game state:", e);
                    return false;
                }
            }

            function loadGameState() {
                if (!isLocalStorageAvailable()) {
                    console.log("LocalStorage not available. Cannot load game state.");
                    return false;
                }

                try {
                    const savedData = localStorage.getItem('virtualPetData');
                    if (!savedData) return false;

                    const data = JSON.parse(savedData);
                    
                    // Restore saved data
                    gameState.selectedPet = data.selectedPet;
                    gameState.petName = data.petName;
                    gameState.stats = data.stats || gameState.stats;
                    
                    // Ensure health stat exists (for compatibility with old saves)
                    if (gameState.stats.health === undefined) {
                        gameState.stats.health = 100;
                        gameState.stats.isSick = false;
                    }
                    
                    gameState.settings = data.settings;
                    gameState.gameTime = data.gameTime;
                    gameState.minigames = data.minigames || gameState.minigames;
                    gameState.inventory = data.inventory || gameState.inventory;
                    gameState.isAsleep = data.isAsleep;
                    gameState.lastSaved = data.lastSaved;

                    return true;
                } catch (e) {
                    console.error("Error loading game state:", e);
                    return false;
                }
            }

            // Setup auto save
            function setupAutoSave() {
                if (gameState.timers.autoSaveInterval) {
                    clearInterval(gameState.timers.autoSaveInterval);
                }

                if (gameState.settings.autoSave) {
                    gameState.timers.autoSaveInterval = setInterval(() => {
                        if (saveGameState()) {
                            showToast("Đã tự động lưu", 1500);
                        }
                    }, 60000); // Save every minute
                }
            }
            
            // Event Listeners
            startButton.addEventListener('click', () => {
                welcomeScreen.classList.add('hidden');
                petSelectionScreen.classList.remove('hidden');
                petSelectionScreen.classList.add('flex');
            });

            continueButton.addEventListener('click', () => {
                if (loadGameState()) {
                    // Initialize the game with saved data
                    initGame(true);
                    
                    // Hide welcome screen, show game screen
                    welcomeScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    gameScreen.classList.add('flex');
                    
                    showToast("Đã tải dữ liệu thú cưng!", 2000);
                } else {
                    showToast("Không tìm thấy dữ liệu đã lưu", 3000);
                }
            });
            
            petCards.forEach((card, index) => {
                card.addEventListener('click', () => {
                    // Remove selected class from all cards
                    petCards.forEach(c => c.classList.remove('border-primary'));
                    // Add selected class to the clicked card
                    card.classList.add('border-primary');
                    // Set selected pet
                    gameState.selectedPet = index;
                });
            });
            
            adoptButton.addEventListener('click', () => {
                if (gameState.selectedPet === null) {
                    showToast('Vui lòng chọn một thú cưng');
                    return;
                }
                
                const name = petNameInput.value.trim();
                if (name === '') {
                    showToast('Vui lòng đặt tên cho thú cưng của bạn');
                    return;
                }
                
                gameState.petName = name;
                petGameName.textContent = name;
                
                // Initialize the game
                initGame(false);
                
                // Hide selection screen, show game screen
                petSelectionScreen.classList.add('hidden');
                petSelectionScreen.classList.remove('flex');
                gameScreen.classList.remove('hidden');
                gameScreen.classList.add('flex');

                // Save initial game state
                if (saveGameState()) {
                    showToast("Đã lưu thú cưng mới!", 2000);
                }
            });
            
            actionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.getAttribute('data-action');
                    
                    // Skip actions when pet is asleep (except wake up)
                    if (gameState.isAsleep && action !== 'sleep') {
                        showToast(`${gameState.petName} đang ngủ. Hãy đánh thức trước!`);
                        return;
                    }
                    
                    if (action === 'play') {
                        // Show minigame selection instead of direct play action
                        pauseGame();
                        showMinigameSelection();
                    } else if (action === 'feed') {
                        // Show food selection
                        showFoodSelection();
                    } else {
                        performAction(action);
                    }
                });
            });

            // Shop button
            shopButton.addEventListener('click', () => {
                showShop();
            });

            // Close shop button
            closeShop.addEventListener('click', () => {
                shopModal.classList.add('hidden');
            });

            // Shop tabs
            shopTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    shopTabs.forEach(t => {
                        t.classList.remove('border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'hover:border-gray-300', 'dark:hover:border-gray-600');
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('border-primary', 'text-primary');
                    tab.classList.remove('border-transparent', 'hover:border-gray-300', 'dark:hover:border-gray-600');
                    
                    // Hide all tab contents
                    foodTab.classList.add('hidden');
                    medicineTab.classList.add('hidden');
                    minigamesTab.classList.add('hidden');
                    toysTab.classList.add('hidden');
                    
                    // Show the selected tab content
                    if (tabName === 'food') {
                        foodTab.classList.remove('hidden');
                    } else if (tabName === 'medicine') {
                        medicineTab.classList.remove('hidden');
                    } else if (tabName === 'minigames') {
                        minigamesTab.classList.remove('hidden');
                    } else if (tabName === 'toys') {
                        toysTab.classList.remove('hidden');
                    }
                });
            });

            // Close food selection
            closeFoodSelection.addEventListener('click', () => {
                foodSelectionModal.classList.add('hidden');
            });

            minigameCards.forEach(card => {
                card.addEventListener('click', () => {
                    const game = card.getAttribute('data-game');
                    startMinigame(game);
                });
            });

            closeMinigame.addEventListener('click', () => {
                hideMinigames();
                resumeGame();
            });

            // Ball Catch Game - Enhanced Version
            let ballCatchGameActive = false;
            let ballCatchInterval = null;
            let ballCatchTimeInterval = null;
            let missedBalls = 0;
            let currentScore = 0;
            let gameTime = 0;
            let ballSpawnRate = 1500; // ms between ball spawns
            let isFreezeModeActive = false;
            let freezeTimeLeft = 0;
            let isHelperModeActive = false;
            let helperTimeLeft = 0;
            let difficulty = 1;
            
            const MAX_MISSED_BALLS = 10;
            const BALL_TYPES = {
                NORMAL: 'normal',
                FAST: 'fast',
                FREEZE: 'freeze',
                HELPER: 'helper',
                DANGER: 'danger'
            };
            
            // Helper pets to catch balls
            let helperPetActive = false;
            let helperIntervals = [];

            // Reset helper pet intervals
            function clearHelperIntervals() {
                helperIntervals.forEach(interval => clearInterval(interval));
                helperIntervals = [];
            }

            startBallCatch.addEventListener('click', () => {
                if (ballCatchGameActive) return;
                
                // Hide instructions
                document.getElementById('ballCatchInstructions').classList.add('hidden');
                
                // Reset game
                ballCatchGameActive = true;
                currentScore = 0;
                gameTime = 0;
                missedBalls = 0;
                difficulty = 1;
                ballSpawnRate = 1500;
                isFreezeModeActive = false;
                isHelperModeActive = false;
                freezeTimeLeft = 0;
                helperTimeLeft = 0;
                
                ballCatchScore.textContent = '0';
                ballCatchTimer.textContent = '0';
                ballCatchMissed.textContent = '0';
                
                // Clear any balls and effects
                const balls = document.querySelectorAll('.game-ball');
                balls.forEach(ball => ball.remove());
                
                freezeEffect.classList.add('hidden');
                petHelperEffect.classList.add('hidden');
                freezeStatus.classList.add('hidden');
                helperStatus.classList.add('hidden');
                helperPetElement.classList.add('hidden');
                
                clearHelperIntervals();
                
                // Add pet to game
                const drawPetFunc = getPetDrawFunction(gameState.selectedPet);
                drawPetFunc(ballCatchPet);
                
                // Start game
                scheduleBallCreation();
                
                // Timer to track game duration and increase difficulty
                ballCatchTimeInterval = setInterval(() => {
                    gameTime++;
                    ballCatchTimer.textContent = gameTime;
                    
                    // Increase difficulty every 15 seconds
                    if (gameTime % 15 === 0) {
                        increaseDifficulty();
                    }
                    
                    // Update freeze effect countdown
                    if (isFreezeModeActive) {
                        freezeTimeLeft--;
                        freezeTime.textContent = freezeTimeLeft;
                        
                        if (freezeTimeLeft <= 0) {
                            deactivateFreezeMode();
                        }
                    }
                    
                    // Update helper effect countdown
                    if (isHelperModeActive) {
                        helperTimeLeft--;
                        helperTime.textContent = helperTimeLeft;
                        
                        if (helperTimeLeft <= 0) {
                            deactivateHelperMode();
                        }
                    }
                }, 1000);
                
                startBallCatch.textContent = 'Đang chơi...';
                startBallCatch.disabled = true;
                startBallCatch.classList.add('opacity-50');
            });

            function scheduleBallCreation() {
                if (!ballCatchGameActive) return;
                
                // Schedule next ball
                ballCatchInterval = setTimeout(() => {
                    createBall();
                    
                    // If active, create a new ball
                    if (ballCatchGameActive) {
                        scheduleBallCreation();
                    }
                }, calculateSpawnDelay());
            }
            
            function calculateSpawnDelay() {
                // Base spawn rate that decreases with difficulty (faster spawns)
                const baseDelay = Math.max(300, ballSpawnRate - (difficulty * 100));
                
                // Add some randomness
                return baseDelay + (Math.random() * 300);
            }
            
            function increaseDifficulty() {
                difficulty = Math.min(10, difficulty + 0.5);
                ballSpawnRate = Math.max(300, ballSpawnRate - 100);
                
                // Show difficulty increase notification
                if (gameTime > 0 && gameTime % 30 === 0) {
                    showToast(`Độ khó tăng lên! Cấp độ: ${Math.floor(difficulty)}`);
                }
            }

            function createBall() {
                if (!ballCatchGameActive) return;
                
                // Determine ball type based on time and randomness
                const ballType = determineBallType();
                
                const ball = document.createElement('div');
                ball.className = 'game-ball absolute w-8 h-8 rounded-full shadow-md cursor-pointer z-10';
                ball.dataset.type = ballType;
                
                // Style based on ball type
                switch (ballType) {
                    case BALL_TYPES.NORMAL:
                        ball.classList.add('bg-yellow-400', 'dark:bg-yellow-500');
                        break;
                    case BALL_TYPES.FAST:
                        ball.classList.add('bg-red-500', 'dark:bg-red-600');
                        break;
                    case BALL_TYPES.FREEZE:
                        ball.classList.add('bg-blue-500', 'dark:bg-blue-600');
                        break;
                    case BALL_TYPES.HELPER:
                        ball.classList.add('bg-green-500', 'dark:bg-green-600');
                        break;
                    case BALL_TYPES.DANGER:
                        ball.classList.add('bg-black', 'dark:bg-gray-900');
                        break;
                }
                
                // Random position at the top
                const left = Math.floor(Math.random() * (ballCatchArea.offsetWidth - 40));
                ball.style.left = `${left}px`;
                ball.style.top = '0';
                
                // Ball caught event
                ball.addEventListener('click', () => handleBallCaught(ball));
                
                // Add ball to the game area
                ballCatchArea.appendChild(ball);
                
                // Animate ball falling
                animateBallFalling(ball, ballType);
            }
            
            function determineBallType() {
                // Base probabilities
                let normalProb = 0.75;
                let fastProb = 0.05 + (Math.min(0.25, difficulty * 0.025)); // Increases with difficulty
                let freezeProb = 0.03;
                let helperProb = 0.07;
                let dangerProb = 0.03 + (Math.min(0.15, difficulty * 0.015)); // Increases with difficulty
                
                // Adjust probabilities based on game time
                if (gameTime > 30) {
                    normalProb -= 0.1;
                    fastProb += 0.05;
                    dangerProb += 0.05;
                }
                
                // Roll for ball type
                const roll = Math.random();
                
                if (roll < dangerProb) return BALL_TYPES.DANGER;
                if (roll < dangerProb + fastProb) return BALL_TYPES.FAST;
                if (roll < dangerProb + fastProb + freezeProb) return BALL_TYPES.FREEZE;
                if (roll < dangerProb + fastProb + freezeProb + helperProb) return BALL_TYPES.HELPER;
                return BALL_TYPES.NORMAL;
            }

            function animateBallFalling(ball, ballType) {
                let topPos = 0;
                let isFrozen = false;
                
                // Determine fall speed based on ball type and difficulty
                let fallSpeed = 1 + (difficulty * 0.3); // Base speed increases with difficulty
                
                if (ballType === BALL_TYPES.FAST) {
                    fallSpeed = fallSpeed * 2.5; // Fast balls fall much quicker
                    // Add visual effect for fast balls
                    ball.classList.add('animate-pulse');
                }
                
                const fallInterval = setInterval(() => {
                    // If game ended or ball was removed
                    if (!ballCatchGameActive || !ball.isConnected) {
                        clearInterval(fallInterval);
                        return;
                    }
                    
                    // Check if in freeze mode
                    if (isFreezeModeActive && ballType !== BALL_TYPES.FREEZE) {
                        isFrozen = true;
                        return; // Don't update position while frozen
                    } else if (isFrozen) {
                        isFrozen = false; // Resume falling after freeze ends
                    }
                    
                    // Update position
                    topPos += fallSpeed;
                    ball.style.top = `${topPos}px`;
                    
                    // Check if ball reaches bottom
                    if (topPos > ballCatchArea.offsetHeight - 32) {
                        clearInterval(fallInterval);
                        
                        // Only count missed balls if still connected to DOM
                        if (ball.isConnected) {
                            handleMissedBall(ball);
                            // Remove ball
                            ball.remove();
                        }
                    }
                    
                    // Check for helper pet auto-catch for normal yellow balls
                    if (isHelperModeActive && ballType === BALL_TYPES.NORMAL && 
                        helperPetElement.classList.contains('active') &&
                        !ball.classList.contains('being-caught') && 
                        Math.random() < 0.03) { // 3% chance per frame to attempt catch
                        
                        tryCatchWithHelper(ball);
                    }
                }, 20);
            }
            
            function tryCatchWithHelper(ball) {
                if (!ball.isConnected) return; // Ball already gone
                
                ball.classList.add('being-caught');
                
                // Move helper toward ball
                const ballRect = ball.getBoundingClientRect();
                const helperRect = helperPetElement.getBoundingClientRect();
                const areaRect = ballCatchArea.getBoundingClientRect();
                
                // Relative positions within the game area
                const ballX = ballRect.left - areaRect.left + (ballRect.width / 2);
                const ballY = ballRect.top - areaRect.top + (ballRect.height / 2);
                
                // Animate helper pet moving to catch the ball
                helperPetElement.style.transition = 'transform 0.3s ease-out';
                helperPetElement.style.transform = `translate(${ballX - helperRect.width}px, ${ballY - helperRect.height}px)`;
                
                // Wait a moment then catch the ball
                setTimeout(() => {
                    if (ball.isConnected) { // Make sure ball still exists
                        handleBallCaught(ball, true);
                    }
                    
                    // Reset helper position after a short delay
                    setTimeout(() => {
                        helperPetElement.style.transition = 'transform 0.5s ease-out';
                        helperPetElement.style.transform = '';
                    }, 200);
                }, 300);
            }

            function handleBallCaught(ball, isCaughtByHelper = false) {
                const ballType = ball.dataset.type;
                
                // Handle special effects
                switch (ballType) {
                    case BALL_TYPES.NORMAL:
                        // Regular ball: 1 point
                        currentScore += 1;
                        break;
                        
                    case BALL_TYPES.FAST:
                        // Fast ball: 3 points
                        currentScore += 3;
                        // Visual feedback
                        showBallCaughtEffect(ball, '+3', 'text-red-500');
                        break;
                        
                    case BALL_TYPES.FREEZE:
                        // Freeze ball: 2 points + freeze effect
                        currentScore += 2;
                        activateFreezeMode();
                        showBallCaughtEffect(ball, 'Đóng băng!', 'text-blue-500');
                        break;
                        
                    case BALL_TYPES.HELPER:
                        // Helper ball: 2 points + helper pet
                        currentScore += 2;
                        activateHelperMode();
                        showBallCaughtEffect(ball, 'Hỗ trợ!', 'text-green-500');
                        break;
                        
                    case BALL_TYPES.DANGER:
                        // Danger ball: 5 points (high risk, high reward)
                        currentScore += 5;
                        showBallCaughtEffect(ball, '+5', 'text-purple-500');
                        break;
                }
                
                // Update score
                ballCatchScore.textContent = currentScore;
                
                // Create pop effect
                if (!isCaughtByHelper) {
                    createPopEffect(ball);
                }
                
                // Remove ball
                ball.remove();
            }
            
            function handleMissedBall(ball) {
                const ballType = ball.dataset.type;
                
                if (ballType === BALL_TYPES.DANGER) {
                    // Danger ball counts as 3 missed balls
                    missedBalls += 3;
                    showMissEffect(ball, '+3 lỗi!', 'text-red-500');
                } else {
                    // Regular missed ball
                    missedBalls += 1;
                }
                
                // Update missed counter
                ballCatchMissed.textContent = missedBalls;
                
                // Check if game over
                if (missedBalls >= MAX_MISSED_BALLS) {
                    endBallCatchGame();
                }
            }
            
            function showBallCaughtEffect(ball, text, colorClass) {
                const effect = document.createElement('div');
                effect.className = `absolute text-lg font-bold ${colorClass} pointer-events-none`;
                effect.textContent = text;
                
                // Position effect at ball location
                const ballRect = ball.getBoundingClientRect();
                const areaRect = ballCatchArea.getBoundingClientRect();
                
                effect.style.left = `${ballRect.left - areaRect.left}px`;
                effect.style.top = `${ballRect.top - areaRect.top}px`;
                
                // Add to game area
                ballCatchArea.appendChild(effect);
                
                // Animate and remove
                effect.animate(
                    [
                        { transform: 'translateY(0)', opacity: 1 },
                        { transform: 'translateY(-20px)', opacity: 0 }
                    ],
                    { duration: 1000, easing: 'ease-out' }
                );
                
                setTimeout(() => effect.remove(), 1000);
            }
            
            function showMissEffect(ball, text, colorClass) {
                const effect = document.createElement('div');
                effect.className = `absolute text-lg font-bold ${colorClass} pointer-events-none`;
                effect.textContent = text;
                
                // Position effect at ball location
                const ballRect = ball.getBoundingClientRect();
                const areaRect = ballCatchArea.getBoundingClientRect();
                
                effect.style.left = `${ballRect.left - areaRect.left}px`;
                effect.style.top = `${ballRect.top - areaRect.top}px`;
                
                // Add to game area
                ballCatchArea.appendChild(effect);
                
                // Animate and remove
                effect.animate(
                    [
                        { transform: 'translateY(0)', opacity: 1 },
                        { transform: 'translateY(20px)', opacity: 0 }
                    ],
                    { duration: 1000, easing: 'ease-out' }
                );
                
                setTimeout(() => effect.remove(), 1000);
            }
            
            function createPopEffect(ball) {
                // Create a pop effect at the ball's position
                const pop = document.createElement('div');
                pop.className = 'absolute w-8 h-8 rounded-full pointer-events-none';
                
                // Get ball's position
                const ballRect = ball.getBoundingClientRect();
                const areaRect = ballCatchArea.getBoundingClientRect();
                
                pop.style.left = `${ballRect.left - areaRect.left}px`;
                pop.style.top = `${ballRect.top - areaRect.top}px`;
                
                // Get ball's color and add to pop effect
                if (ball.classList.contains('bg-yellow-400')) {
                    pop.classList.add('bg-yellow-300');
                } else if (ball.classList.contains('bg-red-500')) {
                    pop.classList.add('bg-red-300');
                } else if (ball.classList.contains('bg-blue-500')) {
                    pop.classList.add('bg-blue-300');
                } else if (ball.classList.contains('bg-green-500')) {
                    pop.classList.add('bg-green-300');
                } else if (ball.classList.contains('bg-black')) {
                    pop.classList.add('bg-gray-600');
                }
                
                // Add to game area
                ballCatchArea.appendChild(pop);
                
                // Animate and remove
                pop.animate(
                    [
                        { transform: 'scale(1)', opacity: 0.7 },
                        { transform: 'scale(1.5)', opacity: 0 }
                    ],
                    { duration: 300, easing: 'ease-out' }
                );
                
                setTimeout(() => pop.remove(), 300);
            }
            
            function activateFreezeMode() {
                isFreezeModeActive = true;
                freezeTimeLeft = 5; // 5 seconds of freeze
                
                // Display freeze effect
                freezeEffect.classList.remove('hidden');
                freezeStatus.classList.remove('hidden');
                freezeTime.textContent = freezeTimeLeft;
                
                // Play freeze sound if enabled
                // (sound effect would be here)
            }
            
            function deactivateFreezeMode() {
                isFreezeModeActive = false;
                freezeEffect.classList.add('hidden');
                freezeStatus.classList.add('hidden');
            }
            
            function activateHelperMode() {
                isHelperModeActive = true;
                helperTimeLeft = 8; // 8 seconds of helper
                
                // Display helper effect
                petHelperEffect.classList.remove('hidden');
                helperStatus.classList.remove('hidden');
                helperTime.textContent = helperTimeLeft;
                
                // Show helper pet
                helperPetElement.classList.remove('hidden');
                helperPetElement.classList.add('active');
                
                // Draw the same pet type for helper
                const drawPetFunc = getPetDrawFunction(gameState.selectedPet);
                drawPetFunc(helperPetElement);
                
                // Play helper sound if enabled
                // (sound effect would be here)
            }
            
            function deactivateHelperMode() {
                isHelperModeActive = false;
                petHelperEffect.classList.add('hidden');
                helperStatus.classList.add('hidden');
                helperPetElement.classList.add('hidden');
                helperPetElement.classList.remove('active');
                
                // Clear helper pet intervals
                clearHelperIntervals();
            }

            function endBallCatchGame() {
                ballCatchGameActive = false;
                
                // Clear all intervals
                clearTimeout(ballCatchInterval);
                clearInterval(ballCatchTimeInterval);
                clearHelperIntervals();
                
                // Deactivate special effects
                deactivateFreezeMode();
                deactivateHelperMode();
                
                // Remove all balls
                const balls = document.querySelectorAll('.game-ball');
                balls.forEach(ball => ball.remove());
                
                // Update high score
                if (currentScore > gameState.minigames.ballCatch.highScore) {
                    gameState.minigames.ballCatch.highScore = currentScore;
                }
                
                // Increment play count
                gameState.minigames.ballCatch.playCount++;
                
                // Calculate rewards based on score and game time
                const baseXP = Math.min(Math.floor(currentScore / 2), 40);
                const timeBonus = Math.min(Math.floor(gameTime / 10), 10);
                
                // Apply sick penalty if applicable
                let xpGain = baseXP + timeBonus;
                if (gameState.stats.isSick) {
                    xpGain = Math.floor(xpGain * 0.5); // 50% penalty
                    showToast("Thú cưng đang bị ốm, thưởng giảm 50%", 3000);
                }
                
                const happinessGain = Math.min(Math.floor(currentScore / 3), 25);
                
                gameState.stats.xp += xpGain;
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + happinessGain);
                gameState.stats.energy = Math.max(0, gameState.stats.energy - 12);
                gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 10); // Reduced hunger
                gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - 8); // Reduced cleanliness
                
                updateUI();
                checkLevelUp();
                
                // Reset button
                startBallCatch.textContent = 'Chơi lại';
                startBallCatch.disabled = false;
                startBallCatch.classList.remove('opacity-50');
                
                // Show game result
                let resultMessage = `Kết thúc! Điểm: ${currentScore}, Thời gian: ${gameTime}s`;
                if (missedBalls >= MAX_MISSED_BALLS) {
                    resultMessage = `Đã bỏ lỡ ${missedBalls}/${MAX_MISSED_BALLS} quả bóng! ` + resultMessage;
                }
                
                showToast(`${resultMessage}, XP +${xpGain}`);
                
                // Show instructions again
                document.getElementById('ballCatchInstructions').classList.remove('hidden');

                // Save game after minigame
                saveGameState();
            }

            // Memory Game
            let memoryCards = [];
            let hasFlippedCard = false;
            let lockBoard = false;
            let firstCard, secondCard;
            let moveCount = 0;
            let pairsFound = 0;

            resetMemoryGame.addEventListener('click', initMemoryGame);

            function initMemoryGame() {
                // Reset game state
                memoryCards = [];
                hasFlippedCard = false;
                lockBoard = false;
                firstCard = null;
                secondCard = null;
                moveCount = 0;
                pairsFound = 0;
                
                memoryMoves.textContent = '0';
                memoryPairs.textContent = '0/8';
                
                // Clear board
                memoryBoard.innerHTML = '';
                
                // Create cards
                const emojis = ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼'];
                const cardEmojis = [...emojis, ...emojis];
                
                // Shuffle
                cardEmojis.sort(() => Math.random() - 0.5);
                
                // Create cards
                cardEmojis.forEach((emoji, index) => {
                    const card = document.createElement('div');
                    card.className = 'memory-card relative h-20 bg-white dark:bg-gray-800 rounded-md shadow cursor-pointer';
                    card.dataset.emoji = emoji;
                    
                    const front = document.createElement('div');
                    front.className = 'front flex items-center justify-center text-3xl';
                    front.textContent = emoji;
                    
                    const back = document.createElement('div');
                    back.className = 'back bg-primary rounded-md flex items-center justify-center';
                    back.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>`;
                    
                    card.appendChild(front);
                    card.appendChild(back);
                    
                    card.addEventListener('click', flipCard);
                    
                    memoryBoard.appendChild(card);
                    memoryCards.push(card);
                });
            }

            function flipCard() {
                if (lockBoard) return;
                if (this === firstCard) return;
                
                this.classList.add('flipped');
                
                if (!hasFlippedCard) {
                    // First click
                    hasFlippedCard = true;
                    firstCard = this;
                    return;
                }
                
                // Second click
                secondCard = this;
                checkForMatch();
            }

            function checkForMatch() {
                moveCount++;
                memoryMoves.textContent = moveCount;
                
                // Check if cards match
                const isMatch = firstCard.dataset.emoji === secondCard.dataset.emoji;
                
                if (isMatch) {
                    disableCards();
                    pairsFound++;
                    memoryPairs.textContent = `${pairsFound}/8`;
                    
                    // Check if game is complete
                    if (pairsFound === 8) {
                        endMemoryGame();
                    }
                } else {
                    unflipCards();
                }
            }

            function disableCards() {
                firstCard.removeEventListener('click', flipCard);
                secondCard.removeEventListener('click', flipCard);
                
                resetBoard();
            }

            function unflipCards() {
                lockBoard = true;
                
                setTimeout(() => {
                    firstCard.classList.remove('flipped');
                    secondCard.classList.remove('flipped');
                    
                    resetBoard();
                }, 1000);
            }

            function resetBoard() {
                [hasFlippedCard, lockBoard] = [false, false];
                [firstCard, secondCard] = [null, null];
            }

            function endMemoryGame() {
                // Update best score
                if (gameState.minigames.memory.bestMoves === 0 || moveCount < gameState.minigames.memory.bestMoves) {
                    gameState.minigames.memory.bestMoves = moveCount;
                }
                
                // Increment play count
                gameState.minigames.memory.playCount++;
                
                // Calculate rewards based on moves
                const perfectScore = 16; // Minimum possible moves
                const maxXP = 25;
                
                // Apply sick penalty if applicable
                let xpGain = Math.max(5, Math.min(maxXP, Math.floor(maxXP * (perfectScore / moveCount))));
                if (gameState.stats.isSick) {
                    xpGain = Math.floor(xpGain * 0.5); // 50% penalty
                    showToast("Thú cưng đang bị ốm, thưởng giảm 50%", 3000);
                }
                
                gameState.stats.xp += xpGain;
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + 15);
                gameState.stats.energy = Math.max(0, gameState.stats.energy - 8);
                gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 5); // Reduced hunger
                gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - 3); // Reduced cleanliness
                
                updateUI();
                checkLevelUp();
                
                setTimeout(() => {
                    showToast(`Chúc mừng! Hoàn thành với ${moveCount} lượt. XP +${xpGain}`);
                }, 1000);

                // Save game after minigame
                saveGameState();
            }

            // Training Game
            let trainingActive = false;
            let currentCommand = null;
            let commandTimer = null;
            let trainingScore = 0;
            let commandsIssued = 0;

            startTraining.addEventListener('click', () => {
                if (trainingActive) return;
                
                // Start training
                trainingActive = true;
                trainingScore = 0;
                commandsIssued = 0;
                
                trainingCommand.textContent = 'Sẵn sàng...';
                trainingInstructions.textContent = 'Quan sát và đợi lệnh!';
                
                startTraining.textContent = 'Đang huấn luyện...';
                startTraining.disabled = true;
                startTraining.classList.add('opacity-50');
                
                // Draw pet for training
                const drawPetFunc = getPetDrawFunction(gameState.selectedPet);
                drawPetFunc(trainingPet);
                
                // Start issuing commands after a delay
                setTimeout(issueCommand, 2000);
            });

            trainingButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (!trainingActive || !currentCommand) return;
                    
                    const command = button.getAttribute('data-command');
                    checkCommand(command);
                });
            });

            function issueCommand() {
                if (!trainingActive) return;
                
                const commands = ['sit', 'roll', 'jump'];
                currentCommand = commands[Math.floor(Math.random() * commands.length)];
                
                let commandText = '';
                switch (currentCommand) {
                    case 'sit': commandText = 'Ngồi xuống!'; break;
                    case 'roll': commandText = 'Lăn tròn!'; break;
                    case 'jump': commandText = 'Nhảy lên!'; break;
                }
                
                trainingCommand.textContent = commandText;
                trainingCommand.classList.add('text-primary', 'animate-pulse');
                trainingInstructions.textContent = 'Nhấn nút lệnh đúng!';
                
                // Set a timer for response
                clearTimeout(commandTimer);
                commandTimer = setTimeout(() => {
                    // Time's up
                    trainingCommand.textContent = 'Quá chậm!';
                    trainingCommand.classList.remove('text-primary', 'animate-pulse');
                    trainingCommand.classList.add('text-red-500');
                    
                    endCommandRound(false);
                }, 3000);
                
                commandsIssued++;
            }

            function checkCommand(command) {
                clearTimeout(commandTimer);
                
                if (command === currentCommand) {
                    // Correct command
                    trainingScore++;
                    trainingCommand.textContent = 'Chính xác!';
                    trainingCommand.classList.remove('text-primary', 'animate-pulse');
                    trainingCommand.classList.add('text-green-500');
                    
                    // Show animation based on command
                    switch (command) {
                        case 'sit':
                            trainingPet.classList.add('transform', 'scale-y-75', 'translate-y-2');
                            setTimeout(() => {
                                trainingPet.classList.remove('transform', 'scale-y-75', 'translate-y-2');
                            }, 1000);
                            break;
                        case 'roll':
                            trainingPet.classList.add('animate-spin');
                            setTimeout(() => {
                                trainingPet.classList.remove('animate-spin');
                            }, 1000);
                            break;
                        case 'jump':
                            trainingPet.classList.add('animate-bounce');
                            setTimeout(() => {
                                trainingPet.classList.remove('animate-bounce');
                            }, 1000);
                            break;
                    }
                    
                    endCommandRound(true);
                } else {
                    // Wrong command
                    trainingCommand.textContent = 'Sai rồi!';
                    trainingCommand.classList.remove('text-primary', 'animate-pulse');
                    trainingCommand.classList.add('text-red-500');
                    
                    endCommandRound(false);
                }
            }

            function endCommandRound(success) {
                setTimeout(() => {
                    trainingCommand.classList.remove('text-green-500', 'text-red-500');
                    
                    // Check if we should end the game
                    if (commandsIssued >= 10) {
                        endTrainingGame();
                    } else {
                        // Issue next command
                        issueCommand();
                    }
                }, 1500);
            }

            function endTrainingGame() {
                trainingActive = false;
                currentCommand = null;
                
                // Calculate percentage score
                const percentage = Math.floor((trainingScore / 10) * 100);
                
                // Update stats
                if (trainingScore > gameState.minigames.training.commandsLearned) {
                    gameState.minigames.training.commandsLearned = trainingScore;
                }
                
                // Increment play count
                gameState.minigames.training.playCount++;
                
                // Apply sick penalty if applicable
                let xpGain = Math.floor(trainingScore * 2.5); // Up to 25 XP for perfect score
                if (gameState.stats.isSick) {
                    xpGain = Math.floor(xpGain * 0.5); // 50% penalty
                    showToast("Thú cưng đang bị ốm, thưởng giảm 50%", 3000);
                }
                
                gameState.stats.xp += xpGain;
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + 10);
                gameState.stats.energy = Math.max(0, gameState.stats.energy - 12);
                gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 8); // Reduced hunger
                gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - 5); // Reduced cleanliness
                
                // If score is 8 or better, give love points
                if (trainingScore >= 8) {
                    gameState.stats.love += 2;
                }
                
                updateUI();
                checkLevelUp();
                
                // Display results
                trainingCommand.textContent = `Huấn luyện hoàn thành!`;
                trainingInstructions.textContent = `Điểm: ${trainingScore}/10 (${percentage}%)`;
                
                startTraining.textContent = 'Huấn luyện lại';
                startTraining.disabled = false;
                startTraining.classList.remove('opacity-50');
                
                showToast(`Kết thúc huấn luyện! Điểm: ${trainingScore}/10, XP +${xpGain}`);

                // Save game after minigame
                saveGameState();
            }

            // Puzzle Game - New
            let puzzleGameActive = false;
            let puzzleInterval = null;
            let puzzleTime = 0;
            let puzzleMoveCount = 0;
            let currentPuzzleSize = 3;
            let puzzleTiles = [];
            let emptyTileIndex = null;

            resetPuzzle.addEventListener('click', initPuzzleGame);
            puzzleDifficulty.addEventListener('change', () => {
                currentPuzzleSize = parseInt(puzzleDifficulty.value);
                initPuzzleGame();
            });

            function initPuzzleGame() {
                // Reset game state
                puzzleGameActive = false;
                clearInterval(puzzleInterval);
                puzzleTime = 0;
                puzzleMoveCount = 0;
                puzzleTiles = [];
                emptyTileIndex = null;
                
                puzzleMoves.textContent = '0';
                puzzleTimer.textContent = '0';
                
                // Clear board
                puzzleBoard.innerHTML = '';
                
                // Set grid columns based on puzzle size
                puzzleBoard.className = `grid grid-cols-${currentPuzzleSize} gap-1 aspect-square w-full max-w-xs mx-auto mb-4 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg`;
                
                // Create tiles
                const totalTiles = currentPuzzleSize * currentPuzzleSize;
                const tiles = Array.from({length: totalTiles - 1}, (_, i) => i + 1); // 1 to totalTiles-1
                
                // Shuffle tiles (ensuring it's solvable)
                do {
                    shuffleArray(tiles);
                } while (!isPuzzleSolvable(tiles, currentPuzzleSize));
                
                // Add empty tile
                tiles.push(null); // Last position is empty
                emptyTileIndex = totalTiles - 1;
                
                // Create tile elements
                tiles.forEach((value, index) => {
                    const tile = document.createElement('div');
                    
                    if (value !== null) {
                        tile.className = 'bg-primary text-white flex items-center justify-center font-bold rounded-md cursor-pointer transition-all hover:bg-primary/90 active:scale-95';
                        tile.textContent = value;
                        
                        // Add click handler
                        tile.addEventListener('click', () => movePuzzleTile(index));
                    } else {
                        tile.className = 'bg-transparent';
                    }
                    
                    puzzleBoard.appendChild(tile);
                    puzzleTiles.push({
                        element: tile,
                        value: value,
                        index: index
                    });
                });
                
                // Start game
                puzzleGameActive = true;
                
                // Start timer
                puzzleInterval = setInterval(() => {
                    puzzleTime++;
                    puzzleTimer.textContent = puzzleTime;
                }, 1000);
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function isPuzzleSolvable(tiles, size) {
                // For puzzle to be solvable:
                // 1. For odd-sized puzzles: number of inversions must be even
                // 2. For even-sized puzzles: sum of inversions and row of empty tile (from bottom) must be odd
                
                // Count inversions
                let inversions = 0;
                for (let i = 0; i < tiles.length; i++) {
                    for (let j = i + 1; j < tiles.length; j++) {
                        if (tiles[i] > tiles[j]) {
                            inversions++;
                        }
                    }
                }
                
                // For odd-sized puzzles
                if (size % 2 === 1) {
                    return inversions % 2 === 0;
                }
                
                // For even-sized puzzles, we assume empty tile is at the last position
                // which is on the bottom row
                // Row from bottom = 1 (for bottom row)
                return (inversions + 1) % 2 === 1;
            }

            function movePuzzleTile(index) {
                if (!puzzleGameActive) return;
                
                // Check if the tile can be moved (adjacent to empty space)
                if (!canMoveTile(index)) return;
                
                // Swap tile with empty space
                const tileValue = puzzleTiles[index].value;
                const tileElement = puzzleTiles[index].element;
                
                // Update the clicked tile to be empty
                tileElement.className = 'bg-transparent';
                tileElement.textContent = '';
                puzzleTiles[index].value = null;
                
                // Update the empty tile to have the value
                const emptyElement = puzzleTiles[emptyTileIndex].element;
                emptyElement.className = 'bg-primary text-white flex items-center justify-center font-bold rounded-md cursor-pointer transition-all hover:bg-primary/90 active:scale-95';
                emptyElement.textContent = tileValue;
                puzzleTiles[emptyTileIndex].value = tileValue;
                
                // Update empty tile index
                emptyTileIndex = index;
                
                // Increment move counter
                puzzleMoveCount++;
                puzzleMoves.textContent = puzzleMoveCount;
                
                // Check if the puzzle is solved
                if (isPuzzleSolved()) {
                    endPuzzleGame();
                }
            }

            function canMoveTile(index) {
                const size = currentPuzzleSize;
                const row = Math.floor(index / size);
                const col = index % size;
                const emptyRow = Math.floor(emptyTileIndex / size);
                const emptyCol = emptyTileIndex % size;
                
                // Tile can move if it's adjacent to the empty space
                return (
                    (row === emptyRow && Math.abs(col - emptyCol) === 1) ||
                    (col === emptyCol && Math.abs(row - emptyRow) === 1)
                );
            }

            function isPuzzleSolved() {
                const totalTiles = currentPuzzleSize * currentPuzzleSize;
                
                // Check if tiles are in order 1, 2, 3, ..., empty
                for (let i = 0; i < totalTiles - 1; i++) {
                    if (puzzleTiles[i].value !== i + 1) {
                        return false;
                    }
                }
                
                // Check if empty tile is in last position
                return puzzleTiles[totalTiles - 1].value === null;
            }

            function endPuzzleGame() {
                puzzleGameActive = false;
                clearInterval(puzzleInterval);
                
                // Calculate score based on moves and time
                // Lower moves and time = better score
                const baseScore = currentPuzzleSize * 100; // Base score depends on difficulty
                const movesPenalty = puzzleMoveCount * 1;
                const timePenalty = puzzleTime * 0.5;
                const score = Math.max(0, Math.floor(baseScore - movesPenalty - timePenalty));
                
                // Update high score if better
                if (score > gameState.minigames.puzzle.highScore) {
                    gameState.minigames.puzzle.highScore = score;
                }
                
                // Increment play count
                gameState.minigames.puzzle.playCount++;
                
                // Apply sick penalty if applicable
                let xpGain = Math.min(Math.floor(score / 4), 30); // Cap at 30 XP
                if (gameState.stats.isSick) {
                    xpGain = Math.floor(xpGain * 0.5); // 50% penalty
                    showToast("Thú cưng đang bị ốm, thưởng giảm 50%", 3000);
                }
                
                gameState.stats.xp += xpGain;
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + 15);
                gameState.stats.energy = Math.max(0, gameState.stats.energy - 10);
                gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 7); // Reduced hunger
                gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - 5); // Reduced cleanliness
                
                updateUI();
                checkLevelUp();
                
                // Show congratulation message
                showToast(`Chúc mừng! Hoàn thành với ${puzzleMoveCount} bước trong ${puzzleTime}s. Điểm: ${score}, XP +${xpGain}`);
                
                // Save game after minigame
                saveGameState();
            }

            // Pet Race Game - New
            let raceActive = false;
            let raceInterval = null;
            let raceRoundNum = 1;
            let racersPositions = [];
            let playerPosition = 0;
            let boostAvailable = 100;
            let boostCooldown = false;
            
            const RACE_MAX_POSITION = 100; // % of track width
            
            startRace.addEventListener('click', () => {
                if (raceActive) return;
                
                initRace();
            });
            
            boostButton.addEventListener('click', useBoost);
            
            function initRace() {
                // Reset race state
                raceActive = true;
                raceRoundNum = 1;
                racersPositions = [0, 0, 0, 0]; // Player + 3 NPCs
                playerPosition = 0;
                boostAvailable = 100;
                boostCooldown = false;
                
                // Setup pet racers
                setupRacers();
                
                // Update UI
                raceRound.textContent = raceRoundNum;
                racePosition.textContent = '?';
                boostBar.style.width = '100%';
                boostButton.disabled = false;
                
                // Start the race!
                startRace.textContent = 'Đang đua...';
                startRace.disabled = true;
                startRace.classList.add('opacity-50');
                
                // Ready, set, go countdown
                showToast('Chuẩn bị...', 1000);
                
                setTimeout(() => {
                    showToast('Sẵn sàng...', 1000);
                    
                    setTimeout(() => {
                        showToast('Bắt đầu!', 1000);
                        startRaceLoop();
                    }, 1000);
                }, 1000);
            }
            
            function setupRacers() {
                // Setup player pet
                const drawPlayerPet = getPetDrawFunction(gameState.selectedPet);
                drawPlayerPet(playerPet);
                playerPet.style.left = '4px';
                
                // Setup NPC pets (using different pet drawings)
                const availablePets = Array.from({length: 8}, (_, i) => i);
                const filteredPets = availablePets.filter(p => p !== gameState.selectedPet);
                
                // Shuffle and pick 3
                shuffleArray(filteredPets);
                const npcPets = filteredPets.slice(0, 3);
                
                const drawNPC1 = getPetDrawFunction(npcPets[0]);
                const drawNPC2 = getPetDrawFunction(npcPets[1]);
                const drawNPC3 = getPetDrawFunction(npcPets[2]);
                
                drawNPC1(npcPet1);
                drawNPC2(npcPet2);
                drawNPC3(npcPet3);
                
                npcPet1.style.left = '4px';
                npcPet2.style.left = '4px';
                npcPet3.style.left = '4px';
            }
            
            function startRaceLoop() {
                raceInterval = setInterval(() => {
                    updateRace();
                    updateRaceUI();
                    
                    // Check if current round has finished
                    if (isRoundFinished()) {
                        endRaceRound();
                    }
                }, 100);
            }
            
            function updateRace() {
                // Calculate speeds for each racer 
                // Player has slightly better base speed
                const playerSpeed = 0.6 + (Math.random() * 0.4);
                const npc1Speed = 0.5 + (Math.random() * 0.5);
                const npc2Speed = 0.5 + (Math.random() * 0.5);
                const npc3Speed = 0.5 + (Math.random() * 0.5);
                
                // Update positions
                racersPositions[0] += playerSpeed;
                racersPositions[1] += npc1Speed;
                racersPositions[2] += npc2Speed;
                racersPositions[3] += npc3Speed;
                
                // Update player position tracking
                playerPosition = racersPositions[0];
                
                // Recover boost slowly
                if (!boostCooldown && boostAvailable < 100) {
                    boostAvailable = Math.min(100, boostAvailable + 0.2);
                    boostBar.style.width = `${boostAvailable}%`;
                }
            }
            
            function updateRaceUI() {
                // Update racer positions on screen
                const trackWidth = raceTrack.offsetWidth - 70; // Account for pet width
                
                playerPet.style.left = `${(racersPositions[0] / RACE_MAX_POSITION) * trackWidth + 4}px`;
                npcPet1.style.left = `${(racersPositions[1] / RACE_MAX_POSITION) * trackWidth + 4}px`;
                npcPet2.style.left = `${(racersPositions[2] / RACE_MAX_POSITION) * trackWidth + 4}px`;
                npcPet3.style.left = `${(racersPositions[3] / RACE_MAX_POSITION) * trackWidth + 4}px`;
                
                // Update player's position rank
                const ranking = getRacePositions();
                const playerRank = ranking.findIndex(pos => pos === 0) + 1;
                racePosition.textContent = playerRank;
            }
            
            function getRacePositions() {
                // Get sorted positions (indexes) from highest to lowest
                return racersPositions
                    .map((pos, idx) => ({pos, idx}))
                    .sort((a, b) => b.pos - a.pos)
                    .map(item => item.idx);
            }
            
            function isRoundFinished() {
                // Check if any racer has finished
                return racersPositions.some(pos => pos >= RACE_MAX_POSITION);
            }
            
            function useBoost() {
                if (boostCooldown || boostAvailable < 20 || !raceActive) return;
                
                // Apply boost to player
                racersPositions[0] += 10;
                
                // Reduce available boost
                boostAvailable = Math.max(0, boostAvailable - 20);
                boostBar.style.width = `${boostAvailable}%`;
                
                // Apply cooldown
                boostCooldown = true;
                boostButton.disabled = true;
                
                // Reset cooldown after 2 seconds
                setTimeout(() => {
                    boostCooldown = false;
                    if (boostAvailable > 0) {
                        boostButton.disabled = false;
                    }
                }, 2000);
            }
            
            function endRaceRound() {
                clearInterval(raceInterval);
                
                // Get final positions
                const finalRanking = getRacePositions();
                const playerRank = finalRanking.findIndex(pos => pos === 0) + 1;
                
                // Show round result
                showToast(`Kết thúc vòng ${raceRoundNum}: Vị trí ${playerRank}`, 2000);
                
                // Check if the race is complete (3 rounds)
                if (raceRoundNum >= 3) {
                    endRace(playerRank);
                } else {
                    // Setup next round
                    setTimeout(() => {
                        raceRoundNum++;
                        
                        // Reset positions but keep score differential
                        // Player gets slight advantage for good performance
                        const playerBonus = playerRank === 1 ? 5 : playerRank === 2 ? 3 : 0;
                        
                        racersPositions = [playerBonus, 0, 0, 0];
                        
                        // Reset UI
                        playerPet.style.left = `${(playerBonus / RACE_MAX_POSITION) * (raceTrack.offsetWidth - 70) + 4}px`;
                        npcPet1.style.left = '4px';
                        npcPet2.style.left = '4px';
                        npcPet3.style.left = '4px';
                        
                        raceRound.textContent = raceRoundNum;
                        
                        // Start next round
                        showToast(`Bắt đầu vòng ${raceRoundNum}!`, 1000);
                        startRaceLoop();
                    }, 2000);
                }
            }
            
            function endRace(finalRank) {
                raceActive = false;
                
                // Count wins
                if (finalRank === 1) {
                    gameState.minigames.race.wins++;
                }
                
                // Increment play count
                gameState.minigames.race.playCount++;
                
                // Calculate rewards based on final position
                const rankXP = finalRank === 1 ? 30 : finalRank === 2 ? 20 : finalRank === 3 ? 10 : 5;
                
                // Apply sick penalty if applicable
                let xpGain = rankXP;
                if (gameState.stats.isSick) {
                    xpGain = Math.floor(xpGain * 0.5); // 50% penalty
                    showToast("Thú cưng đang bị ốm, thưởng giảm 50%", 3000);
                }
                
                gameState.stats.xp += xpGain;
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + 15);
                gameState.stats.energy = Math.max(0, gameState.stats.energy - 15);
                gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 10); // Reduced hunger
                gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - 7); // Reduced cleanliness
                
                updateUI();
                checkLevelUp();
                
                // Reset for next race
                startRace.textContent = 'Bắt đầu đua';
                startRace.disabled = false;
                startRace.classList.remove('opacity-50');
                
                // Show race result
                const resultMessage = finalRank === 1 ? "Vô địch!" : 
                                     finalRank === 2 ? "Á quân!" : 
                                     finalRank === 3 ? "Hạng ba!" : 
                                     "Hạng tư";
                
                showToast(`Kết quả cuộc đua: ${resultMessage} XP +${xpGain}`, 3000);
                
                // Save game after minigame
                saveGameState();
            }

            function showMinigameSelection() {
                minigameScreen.classList.remove('hidden');
                minigameScreen.classList.add('flex');
                gameScreen.classList.add('hidden');
                
                // Show unlocked minigames
                if (gameState.minigames.puzzle.unlocked) {
                    puzzleGameCard.classList.remove('hidden');
                }
                if (gameState.minigames.race.unlocked) {
                    raceGameCard.classList.remove('hidden');
                }
                
                // Show selection, hide all games
                minigameSelection.classList.remove('hidden');
                ballCatchGame.classList.add('hidden');
                memoryGame.classList.add('hidden');
                trainingGame.classList.add('hidden');
                puzzleGame.classList.add('hidden');
                raceGame.classList.add('hidden');
                
                minigameTitle.textContent = "Chọn Trò Chơi";
            }

            function startMinigame(game) {
                // Hide selection, show specific game
                minigameSelection.classList.add('hidden');
                
                switch (game) {
                    case 'ballcatch':
                        ballCatchGame.classList.remove('hidden');
                        minigameTitle.textContent = "Trò Chơi Bắt Bóng";
                        // Initialize ball catch game
                        const drawPetFunc = getPetDrawFunction(gameState.selectedPet);
                        drawPetFunc(ballCatchPet);
                        break;
                    case 'memory':
                        memoryGame.classList.remove('hidden');
                        minigameTitle.textContent = "Trò Chơi Trí Nhớ";
                        // Initialize memory game
                        initMemoryGame();
                        break;
                    case 'training':
                        trainingGame.classList.remove('hidden');
                        minigameTitle.textContent = "Huấn Luyện Thú Cưng";
                        break;
                    case 'puzzle':
                        puzzleGame.classList.remove('hidden');
                        minigameTitle.textContent = "Trò Chơi Xếp Hình";
                        // Initialize puzzle game
                        initPuzzleGame();
                        break;
                    case 'race':
                        raceGame.classList.remove('hidden');
                        minigameTitle.textContent = "Đua Thú Cưng";
                        break;
                }
            }

            function hideMinigames() {
                minigameScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                
                // Clean up any active games
                if (ballCatchGameActive) {
                    endBallCatchGame();
                }
                
                if (trainingActive) {
                    clearTimeout(commandTimer);
                    trainingActive = false;
                }

                if (puzzleGameActive) {
                    clearInterval(puzzleInterval);
                    puzzleGameActive = false;
                }

                if (raceActive) {
                    clearInterval(raceInterval);
                    raceActive = false;
                }
            }
            
            settingsButton.addEventListener('click', () => {
                // Pause game while settings is open
                pauseGame();
                
                // Update settings UI
                soundToggle.checked = gameState.settings.sound;
                notificationToggle.checked = gameState.settings.notification;
                gameSpeedSelect.value = gameState.settings.gameSpeed;
                autoSaveToggle.checked = gameState.settings.autoSave;
                
                // Show settings
                settingsModal.classList.remove('hidden');
            });
            
            closeSettings.addEventListener('click', () => {
                // Hide settings
                settingsModal.classList.add('hidden');
                
                // Resume game
                resumeGame();
            });
            
            resetGameButton.addEventListener('click', () => {
                if (confirm('Bạn có chắc muốn bắt đầu lại? Tất cả tiến trình sẽ bị mất.')) {
                    resetGame();
                }
            });

            saveGameButton.addEventListener('click', () => {
                if (saveGameState()) {
                    showToast("Đã lưu thành công!");
                } else {
                    showToast("Không thể lưu dữ liệu");
                }
            });
            
            soundToggle.addEventListener('change', () => {
                gameState.settings.sound = soundToggle.checked;
            });
            
            notificationToggle.addEventListener('change', () => {
                gameState.settings.notification = notificationToggle.checked;
            });
            
            gameSpeedSelect.addEventListener('change', () => {
                gameState.settings.gameSpeed = gameSpeedSelect.value;
            });

            autoSaveToggle.addEventListener('change', () => {
                gameState.settings.autoSave = autoSaveToggle.checked;
                setupAutoSave();
            });
            
            // Food and Shop Functions
            function showFoodSelection() {
                // Populate food list
                populateFoodList();
                
                // Show food selection modal
                foodSelectionModal.classList.remove('hidden');
            }

            function populateFoodList() {
                foodList.innerHTML = '';
                
                // Check if there's food in inventory
                if (gameState.inventory.food && gameState.inventory.food.length > 0) {
                    // Group food by type to show quantity
                    const foodCounts = {};
                    gameState.inventory.food.forEach(foodId => {
                        foodCounts[foodId] = (foodCounts[foodId] || 0) + 1;
                    });
                    
                    // Create an element for each food type in inventory
                    Object.keys(foodCounts).forEach(foodId => {
                        const count = foodCounts[foodId];
                        const food = foodItems.find(f => f.id === parseInt(foodId));
                        
                        if (food) {
                            const foodElement = createFoodElement(food, count, true);
                            foodList.appendChild(foodElement);
                        }
                    });
                } else {
                    // No food in inventory
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'col-span-2 text-center py-6 text-gray-500 dark:text-gray-400';
                    emptyMessage.textContent = 'Không có thức ăn trong túi. Mua thức ăn tại Cửa hàng.';
                    foodList.appendChild(emptyMessage);
                }
            }

            function createFoodElement(food, count = 0, isFromInventory = false) {
                const canAfford = gameState.stats.coins >= food.price;
                const isPetPreferred = isPetPreferredFood(food.id);
                
                const foodElement = document.createElement('div');
                foodElement.className = `relative bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm ${(isFromInventory || canAfford) ? 'cursor-pointer hover:shadow' : 'opacity-50'}`;
                
                // Indicator for pet-preferred food
                if (isPetPreferred) {
                    const preferredBadge = document.createElement('div');
                    preferredBadge.className = 'absolute -top-1 -right-1 bg-yellow-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center';
                    preferredBadge.innerHTML = '★';
                    foodElement.appendChild(preferredBadge);
                }
                
                // Food content
                foodElement.innerHTML += `
                    <div class="flex flex-col items-center">
                        <div class="text-3xl mb-1">${food.img}</div>
                        <div class="text-sm font-medium">${food.name}</div>
                        <div class="text-xs mt-1 flex items-center">
                            ${isFromInventory ? 
                                `<span class="text-gray-500 dark:text-gray-400">Số lượng: ${count}</span>` : 
                                `<span class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    ${food.price}
                                </span>`
                            }
                        </div>
                    </div>
                `;
                
                // Add click handler
                if (isFromInventory) {
                    foodElement.addEventListener('click', () => {
                        useFood(food.id);
                        foodSelectionModal.classList.add('hidden');
                    });
                } else if (canAfford) {
                    foodElement.addEventListener('click', () => {
                        buyFood(food.id);
                    });
                }
                
                return foodElement;
            }

            function isPetPreferredFood(foodId) {
                // Check if this food is preferred by the current pet
                const petPreferences = gameState.foodPreferences.find(p => p.type === gameState.selectedPet);
                return petPreferences && petPreferences.preferences.includes(foodId);
            }

            function useFood(foodId) {
                // Find the food in inventory
                const foodIndex = gameState.inventory.food.findIndex(f => f === foodId);
                if (foodIndex === -1) return false;
                
                // Remove food from inventory
                gameState.inventory.food.splice(foodIndex, 1);
                
                // Get food details
                const food = foodItems.find(f => f.id === foodId);
                if (!food) return false;
                
                // Check if it's a preferred food for extra happiness
                const isPreferred = isPetPreferredFood(foodId);
                const happinessMultiplier = isPreferred ? 1.5 : 1;
                
                // Apply food effects
                gameState.stats.hunger = Math.min(100, gameState.stats.hunger + food.hunger);
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + (food.happiness * happinessMultiplier));
                
                // Check for food quality effect on sickness
                const sickChance = food.risk;
                if (Math.random() < sickChance && !gameState.stats.isSick) {
                    // Pet gets sick from low-quality food
                    gameState.stats.isSick = true;
                    gameState.stats.health = 50; // Start at 50% health
                    showToast(`${gameState.petName} bị ốm do ăn thức ăn chất lượng thấp!`, 3000);
                    activePet.classList.remove('pet-bounce', 'pet-shake', 'pet-pulse');
                    activePet.classList.add('pet-sick');
                    healthStatus.classList.remove('hidden');
                }
                
                // Show food animation
                showFoodAnimation(food);
                
                // Add XP and love
                addXP(3);
                gameState.stats.love += 1;
                
                // Update UI
                updateUI();
                
                // Save game
                if (gameState.settings.autoSave) {
                    saveGameState();
                }
                
                return true;
            }

            function showFoodAnimation(food) {
                // Display food icon
                foodItem.innerHTML = `<div class="text-4xl">${food.img}</div>`;
                foodContainer.classList.remove('hidden');
                
                // Show pet eating animation
                activePet.classList.add('pet-pulse');
                showEmotion(isPetPreferredFood(food.id) ? '😋' : '🍽️');
                
                // Hide food after animation
                setTimeout(() => {
                    foodContainer.classList.add('hidden');
                    activePet.classList.remove('pet-pulse');
                }, 3000);
            }

            function showShop() {
                // Update coins display
                shopCoins.textContent = gameState.stats.coins;
                
                // Populate shop tabs
                populateShopTabs();
                
                // Show first tab by default
                document.querySelector('.shop-tab[data-tab="food"]').click();
                
                // Show shop modal
                shopModal.classList.remove('hidden');
            }

            function populateShopTabs() {
                // Populate Food Tab
                foodTab.querySelector('.grid').innerHTML = '';
                foodItems.forEach(food => {
                    const foodElement = createFoodElement(food);
                    foodTab.querySelector('.grid').appendChild(foodElement);
                });
                
                // Populate Medicine Tab
                medicineTab.querySelector('.grid').innerHTML = '';
                medicineItems.forEach(medicine => {
                    const medicineElement = createMedicineElement(medicine);
                    medicineTab.querySelector('.grid').appendChild(medicineElement);
                });
                
                // Populate Minigames Tab
                lockedMinigames.querySelector('.grid').innerHTML = '';
                unlockedMinigames.querySelector('.grid').innerHTML = '';
                
                minigameItems.forEach(minigame => {
                    // Check if already unlocked
                    if (gameState.minigames[minigame.game].unlocked) {
                        const minigameElement = createUnlockedMinigameElement(minigame);
                        unlockedMinigames.querySelector('.grid').appendChild(minigameElement);
                    } else {
                        const minigameElement = createMinigameElement(minigame);
                        lockedMinigames.querySelector('.grid').appendChild(minigameElement);
                    }
                });
                
                // Populate Toys Tab
                toysTab.querySelector('.grid').innerHTML = '';
                toyItems.forEach(toy => {
                    const toyElement = createToyElement(toy);
                    toysTab.querySelector('.grid').appendChild(toyElement);
                });
            }

            function createMedicineElement(medicine) {
                const canAfford = gameState.stats.coins >= medicine.price;
                
                const medicineElement = document.createElement('div');
                medicineElement.className = `bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm ${canAfford ? 'cursor-pointer hover:shadow' : 'opacity-50'}`;
                
                medicineElement.innerHTML = `
                    <div class="flex flex-col items-center">
                        <div class="text-3xl mb-1">${medicine.img}</div>
                        <div class="text-sm font-medium">${medicine.name}</div>
                        <div class="text-xs mt-1 flex flex-col items-center">
                            <span class="text-gray-500 dark:text-gray-400 text-center mb-1">${medicine.description}</span>
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${medicine.price}
                            </span>
                        </div>
                    </div>
                `;
                
                // Add click handler
                if (canAfford) {
                    medicineElement.addEventListener('click', () => {
                        buyMedicine(medicine.id);
                    });
                }
                
                return medicineElement;
            }

            function createMinigameElement(minigame) {
                const canAfford = gameState.stats.coins >= minigame.price;
                
                const minigameElement = document.createElement('div');
                minigameElement.className = `bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm ${canAfford ? 'cursor-pointer hover:shadow' : 'opacity-50'}`;
                
                minigameElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-3xl mr-3">${minigame.img}</div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${minigame.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${minigame.description}</div>
                            <div class="text-xs mt-1 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${minigame.price}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add click handler
                if (canAfford) {
                    minigameElement.addEventListener('click', () => {
                        buyMinigame(minigame.game);
                    });
                }
                
                return minigameElement;
            }

            function createUnlockedMinigameElement(minigame) {
                const minigameElement = document.createElement('div');
                minigameElement.className = 'bg-gray-100 dark:bg-gray-700 rounded-lg p-3 shadow-sm';
                
                minigameElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-3xl mr-3">${minigame.img}</div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${minigame.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Đã mở khóa</div>
                        </div>
                    </div>
                `;
                
                return minigameElement;
            }

            function createToyElement(toy) {
                const canAfford = gameState.stats.coins >= toy.price;
                
                const toyElement = document.createElement('div');
                toyElement.className = `bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm ${canAfford ? 'cursor-pointer hover:shadow' : 'opacity-50'}`;
                
                toyElement.innerHTML = `
                    <div class="flex flex-col items-center">
                        <div class="text-3xl mb-1">${toy.img}</div>
                        <div class="text-sm font-medium">${toy.name}</div>
                        <div class="text-xs mt-1 flex flex-col items-center">
                            <span class="text-gray-500 dark:text-gray-400 text-center mb-1">${toy.description}</span>
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${toy.price}
                            </span>
                        </div>
                    </div>
                `;
                
                // Add click handler
                if (canAfford) {
                    toyElement.addEventListener('click', () => {
                        buyToy(toy.id);
                    });
                }
                
                return toyElement;
            }

            function buyFood(foodId) {
                const food = foodItems.find(f => f.id === foodId);
                if (!food) return false;
                
                // Check if player has enough coins
                if (gameState.stats.coins < food.price) {
                    showToast("Không đủ xu để mua!", 2000);
                    return false;
                }
                
                // Deduct coins
                gameState.stats.coins -= food.price;
                
                // Add to inventory
                if (!gameState.inventory.food) {
                    gameState.inventory.food = [];
                }
                gameState.inventory.food.push(foodId);
                
                // Update UI
                updateUI();
                shopCoins.textContent = gameState.stats.coins;
                
                // Show toast
                showToast(`Đã mua ${food.name}!`, 2000);
                
                // Save game
                if (gameState.settings.autoSave) {
                    saveGameState();
                }
                
                return true;
            }

            function buyMedicine(medicineId) {
                const medicine = medicineItems.find(m => m.id === medicineId);
                if (!medicine) return false;
                
                // Check if player has enough coins
                if (gameState.stats.coins < medicine.price) {
                    showToast("Không đủ xu để mua!", 2000);
                    return false;
                }
                
                // Check if pet is sick
                if (!gameState.stats.isSick) {
                    showToast(`${gameState.petName} không bị ốm!`, 2000);
                    return false;
                }
                
                // Deduct coins
                gameState.stats.coins -= medicine.price;
                
                // Apply medicine effects
                gameState.stats.health = Math.min(100, gameState.stats.health + medicine.healing);
                
                // Check if pet is healed
                if (gameState.stats.health >= 100) {
                    gameState.stats.isSick = false;
                    activePet.classList.remove('pet-sick');
                    healthStatus.classList.add('hidden');
                    showToast(`${gameState.petName} đã khỏi bệnh!`, 3000);
                } else {
                    showToast(`Sức khỏe của ${gameState.petName} đã được cải thiện!`, 2000);
                }
                
                // Show medicine animation
                showMedicineAnimation();
                
                // Update UI
                updateUI();
                shopCoins.textContent = gameState.stats.coins;
                
                // Save game
                if (gameState.settings.autoSave) {
                    saveGameState();
                }
                
                return true;
            }

            function showMedicineAnimation() {
                medicineEffect.classList.remove('hidden');
                medicineEffect.classList.add('medicine-effect');
                
                setTimeout(() => {
                    medicineEffect.classList.add('hidden');
                    medicineEffect.classList.remove('medicine-effect');
                }, 1000);
            }

            function buyMinigame(gameType) {
                const minigame = minigameItems.find(m => m.game === gameType);
                if (!minigame) return false;
                
                // Check if player has enough coins
                if (gameState.stats.coins < minigame.price) {
                    showToast("Không đủ xu để mua!", 2000);
                    return false;
                }
                
                // Check if already unlocked
                if (gameState.minigames[gameType].unlocked) {
                    showToast("Trò chơi này đã được mở khóa!", 2000);
                    return false;
                }
                
                // Deduct coins
                gameState.stats.coins -= minigame.price;
                
                // Unlock minigame
                gameState.minigames[gameType].unlocked = true;
                
                // Update UI
                updateUI();
                shopCoins.textContent = gameState.stats.coins;
                
                // Show toast
                showToast(`Đã mở khóa trò chơi ${minigame.name}!`, 2000);
                
                // Refresh shop
                populateShopTabs();
                
                // Show the new minigame in selection
                if (gameType === 'puzzle') {
                    puzzleGameCard.classList.remove('hidden');
                } else if (gameType === 'race') {
                    raceGameCard.classList.remove('hidden');
                }
                
                // Save game
                if (gameState.settings.autoSave) {
                    saveGameState();
                }
                
                return true;
            }

            function buyToy(toyId) {
                const toy = toyItems.find(t => t.id === toyId);
                if (!toy) return false;
                
                // Check if player has enough coins
                if (gameState.stats.coins < toy.price) {
                    showToast("Không đủ xu để mua!", 2000);
                    return false;
                }
                
                // Deduct coins
                gameState.stats.coins -= toy.price;
                
                // Apply toy effects
                gameState.stats.happiness = Math.min(100, gameState.stats.happiness + toy.happiness);
                
                // Update UI
                updateUI();
                shopCoins.textContent = gameState.stats.coins;
                
                // Show toy animation
                showEmotion('🎮');
                
                // Show toast
                showToast(`${gameState.petName} rất thích món đồ chơi mới!`, 2000);
                
                // Save game
                if (gameState.settings.autoSave) {
                    saveGameState();
                }
                
                return true;
            }
            
            // Game Functions
            function initGame(isLoaded) {
                // Set active pet if not loading saved game
                if (!isLoaded) {
                    // Reset game state to default values
                    gameState.stats = {
                        hunger: 100,
                        happiness: 100,
                        cleanliness: 100,
                        energy: 100,
                        health: 100,
                        isSick: false,
                        age: 1,
                        love: 0,
                        xp: 0,
                        coins: 50,
                        level: 1
                    };
                    gameState.gameTime = {
                        day: 1,
                        hour: 12,
                        minute: 0
                    };
                    gameState.inventory = {
                        food: [11, 12], // Start with some high-quality food
                        medicine: [],
                        toys: []
                    };
                    gameState.minigames = {
                        ballCatch: {
                            highScore: 0,
                            playCount: 0
                        },
                        memory: {
                            bestMoves: 0,
                            playCount: 0 
                        },
                        training: {
                            commandsLearned: 0,
                            playCount: 0
                        },
                        puzzle: {
                            highScore: 0,
                            playCount: 0,
                            unlocked: false
                        },
                        race: {
                            wins: 0,
                            playCount: 0,
                            unlocked: false
                        }
                    };
                    gameState.isAsleep = false;
                }

                // Set active pet
                const drawPetFunc = getPetDrawFunction(gameState.selectedPet);
                drawPetFunc(activePet);
                
                // Check if pet is sick and apply visual
                if (gameState.stats.isSick) {
                    activePet.classList.add('pet-sick');
                    healthStatus.classList.remove('hidden');
                } else {
                    activePet.classList.remove('pet-sick');
                    healthStatus.classList.add('hidden');
                }
                
                // Update sleep/wake button text based on state
                updateSleepButtonText();
                
                // Start stats decrease interval
                startTimers();

                // Setup auto save
                setupAutoSave();
                
                // Update UI
                updateUI();
                
                // Set pet name in UI
                petGameName.textContent = gameState.petName;
                petLevel.textContent = `Lv.${gameState.stats.level}`;
            }

            function getPetDrawFunction(petIndex) {
                switch (petIndex) {
                    case 0: return drawCat;
                    case 1: return drawRabbit;
                    case 2: return drawDinosaur;
                    case 3: return drawPanda;
                    case 4: return drawDog;
                    case 5: return drawBird;
                    case 6: return drawFish;
                    case 7: return drawHamster;
                    default: return drawCat;
                }
            }
            
            function startTimers() {
                // Clear any existing intervals
                if (gameState.timers.statsInterval) clearInterval(gameState.timers.statsInterval);
                if (gameState.timers.dayInterval) clearInterval(gameState.timers.dayInterval);
                if (gameState.timers.sickInterval) clearInterval(gameState.timers.sickInterval);
                
                // Stats decrease every 10 seconds
                gameState.timers.statsInterval = setInterval(() => {
                    decreaseStats();
                }, 10000);
                
                // Game time progresses (1 game hour = 15 real seconds)
                gameState.timers.dayInterval = setInterval(() => {
                    updateGameTime();
                }, 15000);
                
                // Check for sickness conditions every 30 seconds
                gameState.timers.sickInterval = setInterval(() => {
                    checkSicknessConditions();
                }, 30000);
            }
            
            function pauseGame() {
                gameState.isPaused = true;
                if (gameState.timers.statsInterval) clearInterval(gameState.timers.statsInterval);
                if (gameState.timers.dayInterval) clearInterval(gameState.timers.dayInterval);
                if (gameState.timers.sickInterval) clearInterval(gameState.timers.sickInterval);
            }
            
            function resumeGame() {
                gameState.isPaused = false;
                startTimers();
            }
            
            function decreaseStats() {
                if (gameState.isPaused) return;
                
                const speedMultiplier = speedMultipliers[gameState.settings.gameSpeed];
                
                // Sleeping pets lose hunger more slowly and recover energy
                if (gameState.isAsleep) {
                    gameState.stats.hunger = Math.max(0, gameState.stats.hunger - (0.5 * speedMultiplier));
                    gameState.stats.energy = Math.min(100, gameState.stats.energy + (2 * speedMultiplier));
                    
                    // If energy is full, pet wakes up
                    if (gameState.stats.energy >= 100) {
                        gameState.isAsleep = false;
                        showToast(`${gameState.petName} đã thức dậy!`);
                        updateSleepButtonText();
                    }
                } else {
                    // Decrease stats based on game speed
                    gameState.stats.hunger = Math.max(0, gameState.stats.hunger - (2 * speedMultiplier));
                    gameState.stats.happiness = Math.max(0, gameState.stats.happiness - (1.5 * speedMultiplier));
                    gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - (1 * speedMultiplier));
                    gameState.stats.energy = Math.max(0, gameState.stats.energy - (1.2 * speedMultiplier));
                    
                    // If pet is sick, health decreases over time
                    if (gameState.stats.isSick) {
                        gameState.stats.health = Math.max(0, gameState.stats.health - (0.5 * speedMultiplier));
                        
                        // If health reaches 0, pet becomes very unhappy
                        if (gameState.stats.health <= 0) {
                            gameState.stats.happiness = Math.max(0, gameState.stats.happiness - 20);
                            showToast(`${gameState.petName} cảm thấy rất tệ vì bệnh nặng!`);
                        }
                    }
                }
                
                // Update UI
                updateUI();
                
                // Check pet mood
                checkPetMood();
            }
            
            function updateSleepButtonText() {
                sleepButtonText.textContent = gameState.isAsleep ? "Đánh thức" : "Ngủ";
            }
            
            function updateGameTime() {
                if (gameState.isPaused) return;
                
                // Advance time by 1 hour
                gameState.gameTime.hour++;
                
                // Day cycle
                if (gameState.gameTime.hour >= 24) {
                    gameState.gameTime.hour = 0;
                    gameState.gameTime.day++;
                    
                    // Daily updates
                    gameState.stats.age++;
                    petAge.textContent = gameState.stats.age;
                    
                    // Give daily rewards
                    gameState.stats.coins += 10;
                    petCoins.textContent = gameState.stats.coins;
                    
                    showEmotion('🎁');
                }
                
                // Update time display
                const hourStr = gameState.gameTime.hour.toString().padStart(2, '0');
                const minuteStr = gameState.gameTime.minute.toString().padStart(2, '0');
                timeDisplay.textContent = `Ngày ${gameState.gameTime.day} - ${hourStr}:${minuteStr}`;
                
                // Update day/night cycle
                updateDayNightCycle();
            }
            
            function updateDayNightCycle() {
                const dayNightCycle = document.getElementById('dayNightCycle');
                const hour = gameState.gameTime.hour;
                
                // Morning (6-10)
                if (hour >= 6 && hour < 10) {
                    dayNightCycle.classList.remove('from-indigo-900', 'from-blue-900');
                    dayNightCycle.classList.add('from-blue-300');
                    document.documentElement.classList.contains('dark') 
                        ? dayNightCycle.classList.add('dark:from-indigo-900') 
                        : dayNightCycle.classList.remove('dark:from-indigo-900');
                }
                // Day (10-17)
                else if (hour >= 10 && hour < 17) {
                    dayNightCycle.classList.remove('from-indigo-900', 'from-blue-900');
                    dayNightCycle.classList.add('from-blue-300');
                    document.documentElement.classList.contains('dark') 
                        ? dayNightCycle.classList.add('dark:from-indigo-900') 
                        : dayNightCycle.classList.remove('dark:from-indigo-900');
                }
                // Evening (17-21)
                else if (hour >= 17 && hour < 21) {
                    dayNightCycle.classList.remove('from-blue-300', 'from-indigo-900');
                    dayNightCycle.classList.add('from-blue-900');
                    document.documentElement.classList.contains('dark') 
                        ? dayNightCycle.classList.add('dark:from-indigo-900') 
                        : dayNightCycle.classList.remove('dark:from-indigo-900');
                }
                // Night (21-6)
                else {
                    dayNightCycle.classList.remove('from-blue-300', 'from-blue-900');
                    dayNightCycle.classList.add('from-indigo-900');
                    document.documentElement.classList.contains('dark') 
                        ? dayNightCycle.classList.add('dark:from-indigo-900') 
                        : dayNightCycle.classList.remove('dark:from-indigo-900');
                }
            }
            
            function checkSicknessConditions() {
                if (gameState.isPaused || gameState.isAsleep || gameState.stats.isSick) return;
                
                // Check if low cleanliness and hunger can cause sickness
                if (gameState.stats.cleanliness < 20 && gameState.stats.hunger < 30) {
                    const sickChance = 0.3; // 30% chance when both conditions are met
                    if (Math.random() < sickChance) {
                        // Pet gets sick
                        gameState.stats.isSick = true;
                        gameState.stats.health = 50; // Start at 50% health
                        showToast(`${gameState.petName} bị ốm do điều kiện tệ!`, 3000);
                        activePet.classList.remove('pet-bounce', 'pet-shake', 'pet-pulse');
                        activePet.classList.add('pet-sick');
                        healthStatus.classList.remove('hidden');
                        
                        // Update UI
                        updateUI();
                    }
                }
            }
            
            function performAction(action) {
                if (gameState.isPaused) return;
                
                activePet.classList.remove('pet-bounce', 'pet-shake', 'pet-pulse');
                
                switch (action) {
                    case 'clean':
                        if (gameState.stats.cleanliness >= 100) {
                            showEmotion('✨');
                            petStatus.textContent = `${gameState.petName} đã rất sạch sẽ!`;
                            return;
                        }
                        
                        // Add cleanliness and reduce happiness slightly
                        gameState.stats.cleanliness = Math.min(100, gameState.stats.cleanliness + 30);
                        gameState.stats.happiness = Math.max(0, gameState.stats.happiness - 5);
                        gameState.stats.energy = Math.max(0, gameState.stats.energy - 3); // Reduced energy
                        
                        // Animation
                        activePet.classList.add('pet-shake');
                        showEmotion('🚿');
                        
                        // Status
                        petStatus.textContent = `${gameState.petName} đang được tắm!`;
                        
                        // Add XP and love
                        addXP(5);
                        gameState.stats.love += 1;
                        break;
                        
                    case 'sleep':
                        if (gameState.isAsleep) {
                            // Wake up
                            gameState.isAsleep = false;
                            showEmotion('😊');
                            petStatus.textContent = `${gameState.petName} đã thức dậy!`;
                            updateSleepButtonText();
                        } else {
                            // Go to sleep
                            gameState.isAsleep = true;
                            gameState.stats.energy = Math.min(100, gameState.stats.energy + 30);
                            showEmotion('💤');
                            petStatus.textContent = `${gameState.petName} đang ngủ ngon!`;
                            updateSleepButtonText();
                            
                            // Add XP and love
                            addXP(5);
                        }
                        break;
                }
                
                // Update UI
                updateUI();
                
                // Reset animation after a delay
                setTimeout(() => {
                    activePet.classList.remove('pet-bounce', 'pet-shake', 'pet-pulse');
                    emotionBubble.classList.add('hidden');
                }, 3000);

                // Save game after action
                if (gameState.settings.autoSave) {
                    saveGameState();
                }
            }
            
            function checkPetMood() {
                // Calculate overall mood based on stats average
                const overallMood = (
                    gameState.stats.hunger + 
                    gameState.stats.happiness + 
                    gameState.stats.cleanliness + 
                    gameState.stats.energy + 
                    (gameState.stats.isSick ? gameState.stats.health : 100) // Include health if sick
                ) / (gameState.stats.isSick ? 5 : 4); // Adjust divisor
                
                if (gameState.stats.isSick) {
                    petStatus.textContent = `${gameState.petName} đang bị ốm!`;
                    showEmotion('🤒');
                } else if (overallMood < 20) {
                    petStatus.textContent = `${gameState.petName} đang rất buồn!`;
                    showEmotion('😢');
                } else if (overallMood < 40) {
                    petStatus.textContent = `${gameState.petName} không được vui lắm`;
                    showEmotion('😞');
                } else if (overallMood < 60) {
                    petStatus.textContent = `${gameState.petName} cảm thấy bình thường`;
                    showEmotion('😐');
                } else if (overallMood < 80) {
                    petStatus.textContent = `${gameState.petName} đang vui!`;
                    showEmotion('😊');
                } else {
                    petStatus.textContent = `${gameState.petName} đang rất hạnh phúc!`;
                    showEmotion('😄');
                }
                
                // Check individual critical stats
                if (gameState.stats.hunger <= 10) {
                    petStatus.textContent = `${gameState.petName} đang rất đói!`;
                    showEmotion('🍽️');
                }
                
                if (gameState.stats.energy <= 10) {
                    petStatus.textContent = `${gameState.petName} cần ngủ!`;
                    showEmotion('😴');
                }
                
                if (gameState.stats.cleanliness <= 10) {
                    petStatus.textContent = `${gameState.petName} cần tắm rửa!`;
                    showEmotion('🧼');
                }
            }
            
            function addXP(amount) {
                gameState.stats.xp += amount;
                checkLevelUp();
                
                // Update XP display
                petXp.textContent = gameState.stats.xp;
            }

            function checkLevelUp() {
                // Level up if XP reaches 100
                if (gameState.stats.xp >= 100) {
                    gameState.stats.level++;
                    gameState.stats.xp = gameState.stats.xp - 100;
                    
                    // Level up rewards
                    gameState.stats.coins += 20;
                    
                    // Show level up message
                    petStatus.textContent = `${gameState.petName} đã lên cấp ${gameState.stats.level}!`;
                    showEmotion('🌟');
                    
                    // Update level display
                    petLevel.textContent = `Lv.${gameState.stats.level}`;

                    // Display toast
                    showToast(`${gameState.petName} đã lên cấp ${gameState.stats.level}!`, 3000);
                }
            }
            
            function showEmotion(emoji) {
                emotionIcon.textContent = emoji;
                emotionBubble.classList.remove('hidden');
                
                // Hide after a few seconds
                setTimeout(() => {
                    emotionBubble.classList.add('hidden');
                }, 3000);
            }
            
            function updateUI() {
                // Update stat bars
                hungerBar.style.width = `${gameState.stats.hunger}%`;
                happinessBar.style.width = `${gameState.stats.happiness}%`;
                cleanlinessBar.style.width = `${gameState.stats.cleanliness}%`;
                energyBar.style.width = `${gameState.stats.energy}%`;
                
                // Update health bar if sick
                if (gameState.stats.isSick) {
                    healthBar.style.width = `${gameState.stats.health}%`;
                    healthValue.textContent = `${Math.round(gameState.stats.health)}%`;
                    healthStatus.classList.remove('hidden');
                } else {
                    healthStatus.classList.add('hidden');
                }
                
                // Update stat values
                hungerValue.textContent = `${Math.round(gameState.stats.hunger)}%`;
                happinessValue.textContent = `${Math.round(gameState.stats.happiness)}%`;
                cleanlinessValue.textContent = `${Math.round(gameState.stats.cleanliness)}%`;
                energyValue.textContent = `${Math.round(gameState.stats.energy)}%`;
                
                // Update stats display
                petLevel.textContent = `Lv.${gameState.stats.level}`;
                petAge.textContent = gameState.stats.age;
                petLove.textContent = gameState.stats.love;
                petXp.textContent = gameState.stats.xp;
                petCoins.textContent = gameState.stats.coins;
                
                // Change stat bar colors based on value
                updateStatColors(hungerBar, gameState.stats.hunger);
                updateStatColors(happinessBar, gameState.stats.happiness);
                updateStatColors(cleanlinessBar, gameState.stats.cleanliness);
                updateStatColors(energyBar, gameState.stats.energy);
                
                // Update health bar color
                if (gameState.stats.isSick) {
                    updateStatColors(healthBar, gameState.stats.health);
                }
                
                // Sleep state
                if (gameState.isAsleep) {
                    activePet.style.opacity = '0.7';
                    petStatus.textContent = `${gameState.petName} đang ngủ ngon!`;
                } else {
                    activePet.style.opacity = '1';
                }

                // Update time display
                const hourStr = gameState.gameTime.hour.toString().padStart(2, '0');
                const minuteStr = gameState.gameTime.minute.toString().padStart(2, '0');
                timeDisplay.textContent = `Ngày ${gameState.gameTime.day} - ${hourStr}:${minuteStr}`;

                // Special animation for fish
                if (gameState.selectedPet === 6) { // Fish
                    activePet.classList.add('pet-float');
                } else {
                    activePet.classList.remove('pet-float');
                }
                
                // If pet is sick, show animation
                if (gameState.stats.isSick) {
                    activePet.classList.add('pet-sick');
                } else {
                    activePet.classList.remove('pet-sick');
                }
            }
            
            function updateStatColors(bar, value) {
                // Remove all color classes
                bar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500');
                
                // Add appropriate color class
                if (value > 70) {
                    bar.classList.add('bg-green-500');
                } else if (value > 40) {
                    bar.classList.add('bg-yellow-500');
                } else if (value > 20) {
                    bar.classList.add('bg-orange-500');
                } else {
                    bar.classList.add('bg-red-500');
                }
            }
            
            function resetGame() {
                // Reset game state
                gameState.selectedPet = null;
                gameState.petName = '';
                gameState.stats = {
                    hunger: 100,
                    happiness: 100,
                    cleanliness: 100,
                    energy: 100,
                    health: 100,
                    isSick: false,
                    age: 1,
                    love: 0,
                    xp: 0,
                    coins: 50,
                    level: 1
                };
                gameState.gameTime = {
                    day: 1,
                    hour: 12,
                    minute: 0
                };
                gameState.minigames = {
                    ballCatch: {
                        highScore: 0,
                        playCount: 0
                    },
                    memory: {
                        bestMoves: 0,
                        playCount: 0 
                    },
                    training: {
                        commandsLearned: 0,
                        playCount: 0
                    },
                    puzzle: {
                        highScore: 0,
                        playCount: 0,
                        unlocked: false
                    },
                    race: {
                        wins: 0,
                        playCount: 0,
                        unlocked: false
                    }
                };
                gameState.inventory = {
                    food: [],
                    medicine: [],
                    toys: []
                };
                gameState.isAsleep = false;
                
                // Clear intervals
                if (gameState.timers.statsInterval) clearInterval(gameState.timers.statsInterval);
                if (gameState.timers.dayInterval) clearInterval(gameState.timers.dayInterval);
                if (gameState.timers.autoSaveInterval) clearInterval(gameState.timers.autoSaveInterval);
                if (gameState.timers.sickInterval) clearInterval(gameState.timers.sickInterval);
                
                // Reset UI
                petCards.forEach(c => c.classList.remove('border-primary'));
                petNameInput.value = '';
                
                // Show selection screen
                welcomeScreen.classList.remove('hidden');
                gameScreen.classList.add('hidden');
                petSelectionScreen.classList.add('hidden');
                minigameScreen.classList.add('hidden');
                settingsModal.classList.add('hidden');
                foodSelectionModal.classList.add('hidden');
                shopModal.classList.add('hidden');
                
                // Reset pet animation
                activePet.classList.remove('pet-bounce', 'pet-shake', 'pet-pulse', 'pet-float', 'pet-sick');
                
                // Hide unlocked minigames
                puzzleGameCard.classList.add('hidden');
                raceGameCard.classList.add('hidden');

                // Clear localStorage
                if (isLocalStorageAvailable()) {
                    localStorage.removeItem('virtualPetData');
                }

                showToast("Đã khởi tạo lại trò chơi!");
            }

            // Check if we have saved data on load
            if (isLocalStorageAvailable() && locaalStorage.getItem('virtualPetData')) {
                continueButton.classList.remove('hidden');
            } else {
                continueButton.classList.add('hidden');
            }
        });
    </script>
>>>>>>> 18ac9070dda7ca80a6838dfe915a58c7e3e25e3b
</body>

</html>